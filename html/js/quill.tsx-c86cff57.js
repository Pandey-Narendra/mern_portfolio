import{r as a,c as _e,f as vt,j as e,E as gt,R as J,k as je,o as bt,s as pe,e as $,L as ne,i as wt}from"./localStorage-e41904e9.js";import{a as jt}from"./client-ebe67c58.js";import{C as yt,R as Nt}from"./reactQueryProviderExtension-ed907ea6.js";import{C as Ct}from"./index-db3d9d77.js";import{s as It,e as le,f as ye,r as ce,B as ae,b as kt,S as O,d as re,p as Ue,C as Ne,v as Tt,c as be,u as St,t as Et,F as Rt,g as fe,h as he,i as xe,j as Lt,k as Pt,l as At,m as Mt,n as Re,o as Le,q as Pe,L as ve,M as Ft}from"./select-b26c20a4.js";import{E as Be,T as Dt}from"./themeContext-e2709bf1.js";import{s as Ge,f as qt,g as Ot,h as _t,i as Ae,j as Ut,k as Y,l as Bt,m as Gt,n as zt,I as Ht,o as Qt,p as ze,q as Vt,r as Kt,t as $t,c as Wt,a as Yt}from"./chatIframe-0e6e32f7.js";/* empty css             */import{g as Jt,h as Xt,u as Z,p as Me,J as Zt,a as Ce}from"./browserPolyfillWrapper-b0fafb12.js";import{a as es,c as ts}from"./cloudFunctions-fcf2e887.js";import{c as ss}from"./tooltip-74945931.js";import"./i18n-a7d9572b.js";import{P as Fe}from"./index-0929ffdc.js";import{c as D,B as F,u as He}from"./button-e9a1516e.js";import{A as Qe,a as Ve}from"./avatar-7730ad60.js";import{f as _}from"./analytics-8361cfa0.js";import{r as De,c as Ke,o as X,f as ge,g as qe,i as Ie,h as ns,e as as}from"./index-f612f062.js";import{u as rs,a as os,b as is,I as Oe}from"./useSSE-9b5541ff.js";import{v as z,I as ls}from"./IconCheck-d416f5fc.js";import{c as V}from"./createReactComponent-8aad68f0.js";import{I as cs}from"./IconPlus-7368eea3.js";import{S as oe,f as ds,l as us,a as ms,T as $e,I as ps}from"./textarea-b3bf5cee.js";import{u as We}from"./useTranslation-e9fdbc7b.js";import{I as fs,u as hs,a as xs,b as vs}from"./index-8b63691d.js";import{s as gs}from"./backend-b694c8c6.js";import{I as Ye}from"./motion-5430e276.js";import{c as Je,P as ke,a as we,b as bs,u as ws,d as js}from"./index-773e7750.js";import{c as ys}from"./index-64a9bfa6.js";import"./persist-4b6dccac.js";import"./index-365c38c1.js";import"./merlin-logo-643be8a2.js";import"./helper-647ff239.js";import"./IconLoader-6ddcdf80.js";import"./webAccess-8c482c3b.js";import"./debounce-c70d88e0.js";import"./utils-03467116.js";import"./postMessageConstants-fa0bb197.js";import"./accordion-05be2e35.js";import"./IconArrowUpRight-c409d730.js";import"./IconArrowLeft-69432c7a.js";import"./cache-e8129ba0.js";var Ns=V("briefcase","IconBriefcase",[["path",{d:"M3 7m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v9a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z",key:"svg-0"}],["path",{d:"M8 7v-2a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v2",key:"svg-1"}],["path",{d:"M12 12l0 .01",key:"svg-2"}],["path",{d:"M3 13a20 20 0 0 0 18 0",key:"svg-3"}]]),Cs=V("message-circle-2","IconMessageCircle2",[["path",{d:"M3 20l1.3 -3.9a9 8 0 1 1 3.4 2.9l-4.7 1",key:"svg-0"}]]),Is=V("power","IconPower",[["path",{d:"M7 6a7.75 7.75 0 1 0 10 0",key:"svg-0"}],["path",{d:"M12 4l0 8",key:"svg-1"}]]),ks=V("replace","IconReplace",[["path",{d:"M3 3m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z",key:"svg-0"}],["path",{d:"M15 15m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z",key:"svg-1"}],["path",{d:"M21 11v-3a2 2 0 0 0 -2 -2h-6l3 3m0 -6l-3 3",key:"svg-2"}],["path",{d:"M3 13v3a2 2 0 0 0 2 2h6l-3 -3m0 6l3 -3",key:"svg-3"}]]),Ts=V("square-filled","IconSquareFilled",[["path",{d:"M19 2h-14a3 3 0 0 0 -3 3v14a3 3 0 0 0 3 3h14a3 3 0 0 0 3 -3v-14a3 3 0 0 0 -3 -3z",fill:"currentColor",key:"svg-0",strokeWidth:"0"}]]),Ss=V("tool","IconTool",[["path",{d:"M7 10h3v-3l-3.5 -3.5a6 6 0 0 1 8 8l6 6a2 2 0 0 1 -3 3l-6 -6a6 6 0 0 1 -8 -8l3.5 3.5",key:"svg-0"}]]);const Es=r=>a.createElement("svg",{viewBox:"0 0 893 900",fill:"none",xmlns:"http://www.w3.org/2000/svg",...r},a.createElement("g",{clipPath:"url(#clip0_31308_141500)"},a.createElement("path",{d:"M893 450C646.465 450 446.5 248.467 446.5 0C446.5 248.467 246.535 450 0 450C246.535 450 446.5 651.533 446.5 900C446.5 651.533 646.465 450 893 450Z",fill:"url(#paint0_linear_31308_141500)",fillOpacity:.7})),a.createElement("defs",null,a.createElement("linearGradient",{id:"paint0_linear_31308_141500",x1:44.5,y1:277,x2:818.5,y2:652.5,gradientUnits:"userSpaceOnUse"},a.createElement("stop",{stopColor:"#6C3BF9"}),a.createElement("stop",{offset:1,stopColor:"#EFCCFF",stopOpacity:.61})),a.createElement("clipPath",{id:"clip0_31308_141500"},a.createElement("rect",{width:893,height:900,fill:"white"})))),Rs=Jt(r=>({ctx:{obj:{},text:""},liveSelectionActive:!1,quickPrompts:[],requestIdHeader:"",setCtx:n=>r({ctx:n}),setLiveSelectionActive:n=>r({liveSelectionActive:n}),setQuickPrompts:n=>r({quickPrompts:n}),setRequestIdHeader:n=>r({requestIdHeader:n}),setUserInput:n=>r({userInput:n}),userInput:{prompt:""}})),ee=r=>Xt(Rs,r),Xe=a.createContext(null);function Ls({children:r}){const n=Z(),[t]=Be({instance:new _e({area:"local"}),key:"quillSettings"},p=>p===void 0?{bio:"",model:"GPT 3",name:"",occupation:"",outputLang:"english",outputLength:"medium",tone:"empathetic",writingStyle:"professional"}:p),[i,u]=a.useState(null),m=a.useRef(null),c=a.useRef(null),l=a.useRef(null),s=It(),{ctx:C,setCtx:I,setLiveSelectionActive:j,setRequestIdHeader:v,setUserInput:g}=ee(p=>({ctx:p.ctx,setCtx:p.setCtx,setLiveSelectionActive:p.setLiveSelectionActive,setRequestIdHeader:p.setRequestIdHeader,setUserInput:p.setUserInput})),y={onClose:()=>{var p;(p=m.current)==null||p.focus(),s.setIsPromptingAvailable(!0),s.editMessageNodeById(s.getLastMessage().id,b=>(b={...b,status:"SUCCESS"},b))},onError:p=>{if(s.setIsPromptingAvailable(!0),console.error(p),s.deleteLastMessage(),(p==null?void 0:p.name)==="CUSTOM_ERROR")if(p.type===gt.RATE_LIMITED){s.setError(n.isPaid?"Your queries have exhausted. Please upgrade your plan to continue using Merlin.":"Your queries have exhausted for today. Subscribe to Merlin Pro to continue using Merlin or come back tomorrow.");return}else s.setError(p.message||"Something went wrong. Please try again later.");else s.setError("Something went wrong. Please try again later.");const b={description:p.message||"Something went wrong. Please try again later.",duration:3e3,title:"Error",variant:"destructive"};Zt.error(b.title,{description:b.description,duration:b.duration})},onMessage:p=>{var w,A,k,d,E;const b=JSON.parse(p.data),q=b.data.content;((w=b==null?void 0:b.data)==null?void 0:w.eventType)==="SYSTEM"&&(b!=null&&b.data.hasOwnProperty("settings")&&(s.setChatId((k=(A=b==null?void 0:b.data)==null?void 0:A.settings)==null?void 0:k.chatId),s.editMessageNodeById(s.getLastMessage().parentId,T=>(T={...T,id:b.data.settings.userMessage.id},T)),s.editMessageNodeById(s.getLastMessage().id,T=>(T={...T,id:b.data.settings.assistantMessage.id,parentId:b.data.settings.userMessage.id},T))),b!=null&&b.data.hasOwnProperty("questions")&&s.setQuestions((d=b==null?void 0:b.data)==null?void 0:d.questions),(E=b==null?void 0:b.data)!=null&&E.metadata&&s.editMessageNodeById(s.getLastMessage().id,T=>(T={...T,metadata:{...T.metadata,...b.data.metadata}},T))),s.editMessageNodeById(s.getLastMessage().id,T=>(T.status==="LOADING"?(T.content=q,T.role="assistant",T.status="STREAMING"):T.status==="STREAMING"&&(T.content=`${T.content}${q}`),T))},onOpen:async p=>{p.ok&&p.headers.get("X-Request-Id")&&v(p.headers.get("X-Request-Id"))}},{handleSSEQuill:o}=rs(`${vt.DOMAIN}/api/v1/quill`,"handleSSEQuill",{method:"POST",...y}),N=a.useCallback(p=>{const b=p.prompt.trim().length>=2e4;if(!p.prompt.trim()||b||!s.isPromptingAvailable)return null;j(!1),s.setError("")},[s]),f=()=>{if(c.current){const p=c.current.querySelector("[data-radix-scroll-area-viewport]");p&&setTimeout(()=>p.scrollTo({behavior:"smooth",left:0,top:p.scrollHeight}),100)}},h=a.useCallback(async p=>{var d,E;if(N(p)===null)return;s.setIsPromptingAvailable(!1),o.reset(),s.setQuestions([]),s.appendMessageThread([{attachments:null,content:p.prompt,id:z(),metadata:{context:""},parentId:((d=s.activeThread[s.activeThread.length-1])==null?void 0:d.id)??"root",role:"user",status:"SUCCESS"},{content:"",id:z(),parentId:"",role:"system",status:"LOADING"}]),l.current.setAttribute("merlin-uid",z());const q=De(),w={ADD_ATTR:["merlin-uid"],FORBID_ATTR:["data-*"],FORBID_TAGS:["style","noscript","script","aside"],USE_PROFILES:{html:!0}},A=Me.sanitize(q,{...w}),k={message:{attachments:null,content:p.prompt,metadata:{context:C.text??""},parentId:((E=s.activeThread[s.activeThread.length-1])==null?void 0:E.id)??"root",role:"user"},metadata:{contextObj:C.obj,dom:A,domain:window.location.hostname},model:t!=null&&t.model&&(t==null?void 0:t.model)==="GPT 4"?"gpt-4":"gpt-3.5-turbo",thread:s.activeThread};l.current.removeAttribute("merlin-uid"),o.execute(k),s.setContext(null),g({prompt:""}),f(),_({eventName:"SubmitPrompt",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/store/context"})},[s,o,N,g,C,t==null?void 0:t.model]),S=a.useCallback(async()=>{var k;if(N({prompt:s.getLastMessage().content??""})===null)return;s.setIsPromptingAvailable(!1),s.insertMessageNode(s.activeThread[s.activeThread.length-2].id,{content:"",id:z(),parentId:s.activeThread[s.activeThread.length-2].id,role:"system",status:"LOADING"}),l.current.setAttribute("merlin-uid",z());const b=De(),q={ADD_ATTR:["merlin-uid"],FORBID_ATTR:["data-*"],FORBID_TAGS:["style","noscript","script","aside"],USE_PROFILES:{html:!0}},w=Me.sanitize(b,{...q}),A={message:{attachments:null,content:s.activeThread[s.activeThread.length-2].content,metadata:{context:C.text??""},parentId:((k=s.activeThread[s.activeThread.length-1])==null?void 0:k.id)??"root",role:"user"},metadata:{contextObj:C.obj,dom:w,domain:window.location.hostname},model:t!=null&&t.model&&(t==null?void 0:t.model)==="GPT 4"?"gpt-4":"gpt-3.5-turbo",thread:s.activeThread.splice(0,s.activeThread.length-2)};l.current.removeAttribute("merlin-uid"),o.execute(A),f(),_({eventName:"RegenerateButton",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/store/context"})},[N,s,o,C,t==null?void 0:t.model]),L=a.useMemo(()=>(o==null?void 0:o.loading)||(o==null?void 0:o.status)==="streaming",[o==null?void 0:o.loading,o==null?void 0:o.status]),P=a.useMemo(()=>(o==null?void 0:o.status)==="success"||(o==null?void 0:o.status)==="idle",[o==null?void 0:o.status]),U=a.useCallback(()=>{m.current&&(m.current.value=""),s.reset({}),s.setError(""),g({prompt:""}),o.reset(),j(!1),I({obj:{selectedText:""},text:""}),s==null||s.reset({})},[o,s]);a.useEffect(()=>{m.current&&m.current.focus(),(async()=>{const b=await es();u(b)})()},[]),a.useEffect(()=>{if(!c.current)return;const p=c.current.querySelector("div");if(p&&o.status==="success"){const b=p.scrollHeight,q=p.scrollTop,w=p.offsetHeight;q+w>=b-50&&f()}},[o.status]);const H={chat:s,handleRegenerateLastMessage:S,handleSSEQuill:o,handleSubmit:h,inputRef:m,isSSELoadingOrStreaming:L,isSSESuccessOrIdle:P,quillPrompts:i,scrollAreaRef:c,startNewChat:U,textareaRef:l};return e.jsx(Xe.Provider,{value:H,children:r})}function te(){const r=J.useContext(Xe);if(!r)throw new Error("useQuillContext must be used within a QuillContextProvider");return r}function Ze(r){const{className:n,icon:t}=r;return t==="replace"?e.jsx(ks,{className:D(n)}):t==="messagecircle2"?e.jsx(Cs,{className:D(n)}):t==="tool"?e.jsx(Ss,{className:D(n)}):t==="briefcase"?e.jsx(Ns,{className:D(n)}):t.startsWith("https")?e.jsx("img",{src:t,className:D(n)}):e.jsx(cs,{className:D(n)})}function W(r){const{item:n,openPortalUi:t}=r;return e.jsx(Y,{className:D("cursor-pointer",r.className),onMouseDown:()=>{t({...n.promptConfig})},onClick:()=>_({eventName:n.copy,eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"}),children:e.jsxs("div",{className:"flex w-full items-center gap-2",children:[e.jsx(Ze,{icon:n.icon,className:"h-4 w-4 stroke-[1.5]"}),e.jsx("div",{children:n.copy})]})},n.copy)}function Ps(r){var K,Q;const{isVisible:n,selectedText:t,setIsVisible:i,setModalOpen:u,textarea:m}=r,{ctx:c,setCtx:l,setLiveSelectionActive:s,setUserInput:C,userInput:I}=ee(x=>({ctx:x.ctx,requestIdHeader:x.requestIdHeader,setCtx:x.setCtx,setLiveSelectionActive:x.setLiveSelectionActive,setUserInput:x.setUserInput,userInput:x.userInput})),[j,v]=a.useState(!1),{chat:g,handleSubmit:y,inputRef:o,quillPrompts:N}=te(),[f,h]=a.useState(!1),S=Z(),L=Ce(),[P,U]=a.useState(!1),[H,p]=a.useState(0),b=a.useRef(null),q=a.useRef(null);a.useEffect(()=>{const x=()=>{ge(m)?v(!0):v(!1)};return x(),m.addEventListener("keyup",x),()=>{m.removeEventListener("keyup",x)}},[]),a.useEffect(()=>{H>0&&y(I)},[H]);function w(x){const{extractContext:M,extractInput:ht,liveSelection:xt,query:de}=x;if(!S.isAuthenticated){i(!0);return}const Ee=ge(m);let ue="";t?ue=t:ht&&Ee&&(ue=Ee);const me=ue.slice(-4e3);l({obj:{selectedText:""},text:me}),i(!0),setTimeout(()=>{var se;(se=o.current)==null||se.focus()},20),de&&C({prompt:de}),xt&&g.activeThread.length===0&&!me&&s(!0),de&&me&&p(se=>se+1)}function A(){if(!N||!N.dropdownItems)return;const{dropdownItems:x}=N;return t&&x.textSelected&&x.textSelected.length>0?e.jsx(e.Fragment,{children:x.textSelected.map(M=>e.jsx(W,{item:M,openPortalUi:w},M.copy))}):ge(m)?e.jsx(e.Fragment,{children:x.inputContent.map(M=>e.jsx(W,{item:M,openPortalUi:w},M.copy))}):e.jsxs(e.Fragment,{children:[x.context&&x.context.length>0&&e.jsx(e.Fragment,{children:x.context.map(M=>c.text?e.jsx(W,{item:M,openPortalUi:w},M.copy):null)}),x.default&&x.default.length>0&&e.jsx(e.Fragment,{children:x.default.map(M=>e.jsx(W,{item:M,openPortalUi:w},M.copy))})]})}const k=a.useCallback(()=>{q.current&&clearTimeout(q.current),U(!0)},[]),d=a.useCallback(()=>{q.current&&clearTimeout(q.current),q.current=window.setTimeout(()=>{U(!1)},300)},[]),E=a.useCallback(x=>{x.stopPropagation();const M={from:"QUILL",payload:{action:"CLOSE_QUILL_THROUGHT_PAGE",data:null}};Ge(()=>{window.parent.postMessage(M,"*")}),_({eventName:"QuillDisableTemporarily",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"})},[]),T=a.useCallback(x=>{E(x),Ke(je.QUILL),_({eventName:"QuillDisableForThis",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"})},[E]),B=a.useCallback(x=>{E(x),L.update(M=>({...M,quill:{isEnabled:!1}})),_({eventName:"QuillDisableForever",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"})},[E]),R=a.useCallback(()=>{h(!0)},[]),G=a.useCallback(()=>{h(!1)},[]);return e.jsxs(qt,{open:P,onOpenChange:x=>{x||U(!1)},modal:!1,children:[(j||n||t)&&e.jsx(Ot,{asChild:!0,onPointerEnter:k,onPointerLeave:d,onPointerDownCapture:x=>{x.preventDefault(),x.stopPropagation()},children:e.jsx("div",{className:D("group/icon flex-center realtive h-5 w-5",{"rounded-full bg-zinc-100":P}),children:e.jsxs("div",{ref:b,className:"flex-center h-full w-full",children:[t&&e.jsx("div",{className:"absolute -right-0 -top-0",children:e.jsxs("span",{className:"relative flex h-1.5 w-1.5",children:[e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-indigo-300 opacity-75"}),e.jsx("span",{className:"relative inline-flex h-1.5 w-1.5 rounded-full bg-indigo-400"})]})}),e.jsx(Es,{className:"h-4 w-4"})]})})}),e.jsxs(_t,{className:"w-56",onPointerEnter:k,onPointerLeave:d,children:[e.jsxs(Ae,{children:[A(),e.jsx("div",{className:"merlinExt-magic-btn-border rounded",children:e.jsx(W,{item:{copy:"Custom Prompt",icon:"plus",promptConfig:{extractContext:!0,extractInput:!0,liveSelection:N&&N.textSelectionWithCustomPrompt||!1}},className:"bg-popover",openPortalUi:w})})]}),e.jsxs(e.Fragment,{children:[e.jsx(Ut,{}),e.jsx(Ae,{children:e.jsxs(Y,{className:"flex justify-between focus:bg-transparent",children:[e.jsxs(Bt,{open:f,onOpenChange:x=>h(x),children:[e.jsx(Gt,{onPointerEnter:R,onPointerLeave:G,onClick:x=>{x.stopPropagation()},hidearrow:"true",children:e.jsx(Is,{className:"h-4 w-4"})}),e.jsxs(zt,{sticky:"partial",onPointerEnter:R,onPointerLeave:G,children:[e.jsx(Y,{className:"cursor-pointer hover:bg-accent",onClick:E,children:"Disable temporarily"}),e.jsx(Y,{className:"cursor-pointer hover:bg-accent",onClick:T,children:"Disable for this site"}),e.jsx(Y,{className:"cursor-pointer hover:bg-accent",onClick:B,children:"Disable forever"})]})]}),e.jsx(F,{variant:"link",size:"xs",onClick:x=>{!S.isLoading&&S.isAuthenticated?(u(M=>!M),_({eventName:"FeedbackModal",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"})):i(!0)},className:"-ml-0.5",children:"Feedback"}),e.jsx(F,{variant:"ghost",size:"icon",onClick:x=>{!S.isLoading&&S.isAuthenticated?(X("https://www.getmerlin.in/dashboard?from=quill"),_({eventName:"OpenMerlinDashboard",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"})):i(!0)},className:"h-fit w-8 p-0 hover:rounded-full",children:e.jsx(Qe,{className:"h-6 w-6",children:e.jsx(Ve,{children:((Q=(K=S.details)==null?void 0:K.name)==null?void 0:Q[0])??"U"})})})]})})]})]})]})}function As(){return e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"flex-center",children:e.jsx(ye,{className:"font-medium leading-5",children:"You need to be logged in to use this feature. Please login or sign up to continue."})}),e.jsx(ce,{className:"flex gap-2",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{onClick:()=>X("https://www.getmerlin.in/sign-in"),children:"Login"}),e.jsx(F,{variant:"secondary",onClick:()=>X("https://www.getmerlin.in/sign-in"),children:"Sign up"})]})})]})}function Ms({handleInsertText:r,index:n,msg:t}){const{t:i}=We(),[u,m]=a.useState(!1),{chat:c,handleRegenerateLastMessage:l,isSSESuccessOrIdle:s}=te(),C=a.useMemo(()=>c.activeThread.length-1===n&&t.role==="assistant",[c.activeThread.length,n,t.role]);function I(j){navigator.clipboard.writeText(j),m(!0),setTimeout(()=>m(!1),1200),_({eventName:"CopyButton",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/messages"})}if(t.role=="user")return e.jsx(e.Fragment,{children:e.jsxs("div",{style:{zIndex:10+n},className:D("bg-background",{"sticky -top-1 pt-1":n===c.activeThread.length-2}),id:"user-msg-container",children:[e.jsxs("div",{className:"flex gap-2",id:`${n===c.activeThread.length-2?"user-msg-body":""}`,children:[e.jsx(ae,{className:"relative mr-2 h-fit",variant:"secondary",children:i("super_gmail.prompt")}),e.jsx("span",{className:"line-clamp-1 max-h-24 overflow-y-auto break-words text-sm",children:t.content})]},t.id),c.activeThread.length-1!==n&&e.jsx(oe,{className:"my-2"})]})});if(t.role==="assistant")return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative flex min-h-[255px] flex-grow flex-col justify-between",children:[e.jsx("div",{className:"whitespace-pre-wrap break-words p-0 pb-6 text-sm",children:t.content.trim()}),s&&e.jsxs("div",{className:"flex w-full items-center gap-2 bg-background p-0.5 text-sm",children:[e.jsx(F,{size:"sm",variant:"secondary",onClick:()=>{r(t.content)},tabIndex:n===c.activeThread.length-1?0:-1,children:i("super_gmail.insert")}),e.jsx("button",{type:"button",className:"bg-transparent p-1 only:rounded-md",onClick:()=>{I(t.content)},tabIndex:n===c.activeThread.length-1?0:-1,disabled:u,children:u?e.jsx(ls,{className:"plain-icon-color h-4 w-4 stroke-[1.5]"}):e.jsx(fs,{className:"plain-icon-color h-4 w-4 stroke-[1.5]"})}),C&&e.jsx("button",{type:"button",className:"bg-transparent p-1 only:rounded-md",onClick:()=>{l()},tabIndex:n===c.activeThread.length-1?0:-1,children:e.jsx(kt,{className:"plain-icon-color h-4 w-4 stroke-[1.5]"})}),t.totSiblings>0&&e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{type:"button",className:"group/btn bg-transparent",onClick:()=>c.switchLeft(t),disabled:t.idx===0,tabIndex:n===c.activeThread.length-1?0:-1,children:e.jsx(os,{className:"plain-icon-color h-4 w-4 stroke-[1.5] group-disabled/btn:opacity-50"})}),e.jsxs("span",{className:"mx-0.5 flex items-end",children:[t.idx+1,e.jsx("span",{className:"relative -top-[1px]",children:"/"}),t.totSiblings]}),e.jsx("button",{type:"button",className:"group/btn bg-transparent",onClick:()=>c.switchRight(t),disabled:t.idx===t.totSiblings-1,tabIndex:n===c.activeThread.length-1?0:-1,children:e.jsx(is,{className:"plain-icon-color h-4 w-4 stroke-[1.5] group-disabled/btn:opacity-50"})})]})]})]}),c.activeThread.length-1!==n&&e.jsx(oe,{className:"my-2"})]});if(t.role==="system")return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex h-[255px] flex-col justify-between",children:e.jsxs("div",{className:"",children:[e.jsx(O,{className:"mb-4 h-2 w-16"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(O,{className:"h-2 w-72"}),e.jsx(O,{className:"h-2 w-32"}),e.jsx(O,{className:"h-2 w-10"}),e.jsx(O,{className:"h-2 w-16"}),e.jsx(O,{className:"h-2 w-96"}),e.jsx(O,{className:"h-2 w-72"}),e.jsx(O,{className:"h-2 w-32"}),e.jsx(O,{className:"h-2 w-10"}),e.jsx(O,{className:"h-2 w-16"}),e.jsx(O,{className:"h-2 w-96"})]}),e.jsx(O,{className:"my-1 mt-4 h-2 w-16"}),e.jsx(O,{className:"h-2 w-20"})]})}),c.activeThread.length-1!==n&&e.jsx(oe,{className:"my-2"})]})}function Fs(r){var f;const{handleInsertText:n,setCurrentMode:t}=r,{chat:i,handleSSEQuill:u,handleSubmit:m,inputRef:c,isSSESuccessOrIdle:l,quillPrompts:s,scrollAreaRef:C}=te(),{ctx:I,setUserInput:j,userInput:v}=ee(h=>({ctx:h.ctx,setUserInput:h.setUserInput,userInput:h.userInput})),g=a.useMemo(()=>(i.activeThread.length>0&&l||i.activeThread.length===0&&I.text.length>5)&&s&&s.quickPrompts,[i.activeThread.length,l,I.text.length,s]),y=J.useRef(null),[o,N]=J.useState(-1);return a.useEffect(()=>{y.current&&y.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[o]),e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"h-[320px] w-full p-4 pb-2",children:e.jsx(re,{className:"intersection-observer-root flex flex-1 flex-col",ref:C,children:e.jsxs("div",{className:"mr-2",children:[e.jsx("div",{className:"flex flex-col gap-2",children:e.jsxs("div",{className:"bg-background",id:"context-msg-container",children:[e.jsxs("div",{className:D("flex gap-2",{"flex-col":i.activeThread.length===0}),children:[i.activeThread.length===0?I.text?e.jsx(ae,{className:"relative h-fit w-fit",variant:"secondary",children:"Selected Context"}):e.jsx(ae,{className:"relative h-fit w-fit",variant:"secondary",children:"No context selected"}):e.jsx(ae,{className:"relative h-fit w-fit",variant:"secondary",children:"Context"}),e.jsx(re,{className:D("w-full resize-none text-sm focus-visible:ring-0",{"h-[260px]":i.activeThread.length===0,"h-24":i.activeThread.length>0}),children:I.text?e.jsx("div",{className:"mr-2 h-full whitespace-pre-wrap break-words text-sm",children:I.text}):e.jsx("div",{className:"tex flex select-none flex-col gap-2",children:e.jsx("ul",{className:"my-2 space-y-2",children:e.jsxs("li",{className:"flex flex-wrap items-center",children:["ðŸ‘ˆ Please select the text that you want to reply to and press",e.jsx("br",{}),e.jsxs("div",{className:"flex items-center gap-1",children:["the send button",e.jsx(Oe,{className:"inline h-3 w-3"}),"."]})]})})})})]}),i.activeThread.length>0&&e.jsx(oe,{className:"my-2"})," "]})}),(f=i.activeThread)==null?void 0:f.map((h,S)=>e.jsx(Ms,{msg:h,index:S,handleInsertText:n},h.id)),i.error&&!i.error.includes("Your queries have exhausted")&&e.jsxs("div",{className:"flex min-h-[200px] flex-grow flex-col justify-between px-2 text-red-500",children:[e.jsx("div",{className:"p-0 text-sm",children:i.error}),e.jsx("div",{className:"mt-2 flex items-center gap-2 text-sm",children:e.jsx(F,{onClick:()=>{m({prompt:i.activeThread[i.activeThread.length-1].content}),N(-1)},children:"Retry"})})]}),i.error&&i.error.includes("Your queries have exhausted")&&e.jsxs("div",{className:"flex min-h-[200px] flex-grow flex-col justify-between px-2",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex",children:[e.jsx("img",{className:"h-8 w-8",src:qe(ds),alt:"face-in-cloud"}),e.jsx("img",{className:"h-8 w-8",src:qe(us),alt:"lightning"})]}),e.jsx("div",{className:"p-0 text-sm",children:"Out of queries"})]}),e.jsx("div",{className:"mt-2 flex items-center gap-2 text-sm",children:e.jsx(F,{onClick:()=>X("https://www.getmerlin.in/pricing?from=quill"),children:"Go Pro"})})]})]})})}),e.jsxs(ce,{className:"flex shrink-0 justify-between gap-2 border-t p-4",children:[e.jsxs("div",{className:"relative flex flex-1 items-center",children:[e.jsx(Ue,{onChange:h=>{N(-1),j({prompt:h.target.value})},value:v.prompt,ref:c,id:"promptInput",placeholder:"Enter your prompt here",autoComplete:"off",onKeyDown:h=>{h.key==="Enter"&&h.shiftKey||h.key==="Enter"&&(h.preventDefault(),m(v),N(-1))},onKeyDownCapture:h=>{if(h.key==="ArrowUp"&&g){if(o===0)return;h.preventDefault(),h.stopPropagation(),N(S=>{const L=S>0?S-1:s.quickPrompts.length-1;return j({prompt:s.quickPrompts[L].prompt}),L})}h.key==="ArrowDown"&&g&&(h.preventDefault(),h.stopPropagation(),N(S=>{const L=S<s.quickPrompts.length-1?S+1:0;return j({prompt:s.quickPrompts[L].prompt}),L}))}}),g&&e.jsx(Ne,{className:"absolute left-0 top-10 w-full rounded-md py-2",children:e.jsx(re,{className:"h-28",children:e.jsx("div",{className:"flex w-full flex-col gap-1 text-sm",children:s.quickPrompts.map((h,S)=>e.jsxs("span",{ref:S===o?y:void 0,onClick:()=>{m({prompt:h.prompt}),N(-1)},className:D("flex cursor-pointer items-center gap-2 px-2 py-1 hover:bg-secondary",{"bg-secondary":o===S}),children:[e.jsx(Ze,{icon:h.icon,className:"h-4 w-4 shrink-0 stroke-[1.5]"}),h.copy]},h.copy))})})})]}),l?e.jsx(F,{variant:"outline",size:"icon",className:"flex-center aspect-square",onClick:()=>{m(v),N(-1)},children:e.jsx(Oe,{className:"h-4 w-4"})}):e.jsx(F,{size:"icon",variant:"outline",className:"flex-center aspect-square",onClick:()=>{i.getLastMessage().content==""&&i.deleteLastMessage(),u.close(),_({eventName:"StopGenerationButton",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/messages"})},children:e.jsx(Ts,{className:"h-4 w-4 text-rose-500"})}),e.jsx(F,{variant:"outline",size:"icon",className:"flex-center aspect-square",onClick:()=>{t("SETTINGS")},children:e.jsx(ms,{className:"h-4 w-4 cursor-pointer"})})]})]})}function Ds({modalOpen:r,setModalOpen:n}){const[t,i]=a.useState(""),[u,m]=a.useState(""),{chat:c}=te(),{requestIdHeader:l,userInput:s}=ee(v=>({requestIdHeader:v.requestIdHeader,userInput:v.userInput})),C=a.useRef(null);a.useEffect(()=>{const v=g=>{g.key==="Escape"&&r&&n(!1)};return window.addEventListener("keydown",v),()=>{window.removeEventListener("keydown",v)}},[r]);const I=Z();async function j(){var y,o;const g=(((y=c.activeThread)==null?void 0:y.slice(0,c.activeThread.length-1))??[]).map(N=>{var f;return{attachments:((f=N.attachments)==null?void 0:f.map(h=>({type:h.type,url:h.url})))??[],content:N.content,role:N.role}});await gs(JSON.stringify({activeChat:g,feature:"QUILL",feedbackMessage:t,userInput:s}),JSON.stringify({generatedResult:"NA"}),u??"negative",window.location.href,((o=I.details)==null?void 0:o.email)??"EMAIL_NOT_FOUND",l)}return e.jsx("div",{className:"fixed left-1/2 top-1/2 z-[1001] h-full max-h-[350px] w-full max-w-[425px] -translate-x-1/2 -translate-y-1/2",ref:C,children:e.jsxs(Ne,{className:"relative flex h-full w-full flex-col justify-between gap-4",children:[e.jsx("div",{className:"absolute -right-4 -top-4",children:e.jsx(F,{variant:"outline",size:"icon",className:"rounded-full",onClick:()=>{n(!1)},children:e.jsx(Ye,{className:"h-4 w-4 stroke-[1.5] text-primary/70"})})}),e.jsxs(le,{className:"flex flex-col gap-2",children:[e.jsx(ye,{children:"Submit feedback"}),e.jsx(Tt,{className:"text-sm text-foreground/70",children:"Please share what you liked / disliked about this feature"})]}),e.jsx(be,{children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx($e,{value:t,className:"w-full resize-none",placeholder:"Write your feedback here",onChange:v=>{i(v.target.value)},rows:4}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{variant:"ghost",size:"icon",className:D("p-0",{"bg-primary/10":u==="positive"}),onClick:()=>{m("positive")},children:e.jsx(Ht,{className:"h-4 w-4 stroke-[1.5] text-primary/70"})}),e.jsx(F,{variant:"ghost",size:"icon",className:D("p-0",{"bg-primary/10":u==="negative"}),onClick:()=>{m("negative")},children:e.jsx(Qt,{className:"h-4 w-4 stroke-[1.5] text-primary/70"})})]})]})}),e.jsxs(ce,{className:"flex gap-2",children:[e.jsx(F,{variant:"outline",onClick:()=>{i(""),n(!1)},children:"Close"}),e.jsx(F,{variant:"merlin",onClick:()=>{if(!u){n(!1);return}j(),i(""),n(!1)},children:"Submit"})]})]})})}var Te="Radio",[qs,et]=Je(Te),[Os,_s]=qs(Te),tt=a.forwardRef((r,n)=>{const{__scopeRadio:t,name:i,checked:u=!1,required:m,disabled:c,value:l="on",onCheck:s,...C}=r,[I,j]=a.useState(null),v=He(n,o=>j(o)),g=a.useRef(!1),y=I?!!I.closest("form"):!0;return e.jsxs(Os,{scope:t,checked:u,disabled:c,children:[e.jsx(ke.button,{type:"button",role:"radio","aria-checked":u,"data-state":at(u),"data-disabled":c?"":void 0,disabled:c,value:l,...C,ref:v,onClick:we(r.onClick,o=>{u||s==null||s(),y&&(g.current=o.isPropagationStopped(),g.current||o.stopPropagation())})}),y&&e.jsx(Us,{control:I,bubbles:!g.current,name:i,value:l,checked:u,required:m,disabled:c,style:{transform:"translateX(-100%)"}})]})});tt.displayName=Te;var st="RadioIndicator",nt=a.forwardRef((r,n)=>{const{__scopeRadio:t,forceMount:i,...u}=r,m=_s(st,t);return e.jsx(bs,{present:i||m.checked,children:e.jsx(ke.span,{"data-state":at(m.checked),"data-disabled":m.disabled?"":void 0,...u,ref:n})})});nt.displayName=st;var Us=r=>{const{control:n,checked:t,bubbles:i=!0,...u}=r,m=a.useRef(null),c=hs(t),l=ws(n);return a.useEffect(()=>{const s=m.current,C=window.HTMLInputElement.prototype,j=Object.getOwnPropertyDescriptor(C,"checked").set;if(c!==t&&j){const v=new Event("click",{bubbles:i});j.call(s,t),s.dispatchEvent(v)}},[c,t,i]),e.jsx("input",{type:"radio","aria-hidden":!0,defaultChecked:t,...u,tabIndex:-1,ref:m,style:{...r.style,...l,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function at(r){return r?"checked":"unchecked"}var Bs=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],Se="RadioGroup",[Gs,Gn]=Je(Se,[ze,et]),rt=ze(),ot=et(),[zs,Hs]=Gs(Se),it=a.forwardRef((r,n)=>{const{__scopeRadioGroup:t,name:i,defaultValue:u,value:m,required:c=!1,disabled:l=!1,orientation:s,dir:C,loop:I=!0,onValueChange:j,...v}=r,g=rt(t),y=xs(C),[o,N]=js({prop:m,defaultProp:u,onChange:j});return e.jsx(zs,{scope:t,name:i,required:c,disabled:l,value:o,onValueChange:N,children:e.jsx(Vt,{asChild:!0,...g,orientation:s,dir:y,loop:I,children:e.jsx(ke.div,{role:"radiogroup","aria-required":c,"aria-orientation":s,"data-disabled":l?"":void 0,dir:y,...v,ref:n})})})});it.displayName=Se;var lt="RadioGroupItem",ct=a.forwardRef((r,n)=>{const{__scopeRadioGroup:t,disabled:i,...u}=r,m=Hs(lt,t),c=m.disabled||i,l=rt(t),s=ot(t),C=a.useRef(null),I=He(n,C),j=m.value===u.value,v=a.useRef(!1);return a.useEffect(()=>{const g=o=>{Bs.includes(o.key)&&(v.current=!0)},y=()=>v.current=!1;return document.addEventListener("keydown",g),document.addEventListener("keyup",y),()=>{document.removeEventListener("keydown",g),document.removeEventListener("keyup",y)}},[]),e.jsx(Kt,{asChild:!0,...l,focusable:!c,active:j,children:e.jsx(tt,{disabled:c,required:m.required,checked:j,...s,...u,name:m.name,ref:I,onCheck:()=>m.onValueChange(u.value),onKeyDown:we(g=>{g.key==="Enter"&&g.preventDefault()}),onFocus:we(u.onFocus,()=>{var g;v.current&&((g=C.current)==null||g.click())})})})});ct.displayName=lt;var Qs="RadioGroupIndicator",dt=a.forwardRef((r,n)=>{const{__scopeRadioGroup:t,...i}=r,u=ot(t);return e.jsx(nt,{...u,...i,ref:n})});dt.displayName=Qs;var ut=it,mt=ct,Vs=dt;const pt=a.forwardRef(({className:r,...n},t)=>e.jsx(ut,{className:D("grid gap-2",r),...n,ref:t}));pt.displayName=ut.displayName;const ie=a.forwardRef(({className:r,...n},t)=>e.jsx(mt,{ref:t,className:D("aspect-square h-4 w-4 rounded-full border border-primary text-primary shadow focus:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",r),...n,children:e.jsx(Vs,{className:"flex items-center justify-center",children:e.jsx(vs,{className:"h-3.5 w-3.5 fill-primary"})})}));ie.displayName=mt.displayName;const Ks=bt({bio:pe(),model:$(["GPT 3","GPT 4"]),name:pe(),occupation:pe(),outputLang:$(["english","hindi"]),outputLength:$(["short","medium","long"]),tone:$(["empathetic","optimistic","sincere","enthusiastic"]),writingStyle:$(["professional","casual","neutral"])});function $s({setCurrentMode:r}){var g,y,o,N;const{t:n}=We(),t=Z(),i=Ce(),[u,m]=a.useState(null),[c,l]=Be({instance:new _e({area:"local"}),key:"quillSettings"}),s=St({defaultValues:{bio:"",model:"GPT 3",name:"",occupation:"",outputLang:"english",outputLength:"medium",tone:"empathetic",writingStyle:"professional"},resolver:Et(Ks)});a.useEffect(()=>{s.reset(c)},[s,c]);function C(f){l(f),r("CHAT"),_({eventData:{...f,disable:u},eventName:"SaveSettings",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/settings"})}const I=a.useCallback(()=>{const f={from:"QUILL",payload:{action:"CLOSE_QUILL_THROUGHT_PAGE",data:null}};Ge(()=>{window.parent.postMessage(f,"*")})},[]),j=a.useCallback(()=>{I(),Ke(je.QUILL)},[I]),v=a.useCallback(()=>{I(),i.update({quill:{isEnabled:!1}})},[I]);return a.useEffect(()=>{(async()=>{if(!await ne.get("quillSettings")){const S=await ne.get("gmailPersona");S?ne.set("quillSettings",S):ne.set("quillSettings",s.getValues())}})()},[]),e.jsxs(be,{className:"flex w-full p-0",children:[e.jsxs("div",{className:"flex w-12 flex-col items-end justify-between gap-2 border-r p-1 py-2",children:[e.jsx("div",{className:"flex flex-col gap-2",children:e.jsx(F,{variant:"ghost",size:"icon",onClick:()=>{r("CHAT")},children:e.jsx(ps,{})})}),e.jsx(F,{variant:"ghost",size:"icon",onClick:()=>X("https://www.getmerlin.in/dashboard"),children:e.jsx(Qe,{className:"h-6 w-6",children:e.jsx(Ve,{children:((N=(o=(y=(g=t.details)==null?void 0:g.name)==null?void 0:y.split(" "))==null?void 0:o.map(f=>f[0]))==null?void 0:N.join(""))??"U"})})})]}),e.jsx("div",{className:"flex h-[362px] w-full flex-col",children:c?e.jsxs(e.Fragment,{children:[e.jsxs(re,{className:"h-[300px]",children:[e.jsx(le,{children:e.jsx(ye,{className:"text-lg",children:n("super_gmail.config")})}),e.jsxs(be,{children:[e.jsx(Rt,{...s,children:e.jsx("form",{onSubmit:s.handleSubmit(C),children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(fe,{control:s.control,name:"model",render:({field:f})=>e.jsxs(he,{children:[e.jsx(xe,{children:n("super_gmail.ai_model")}),e.jsxs(Lt,{onValueChange:f.onChange,value:f.value,children:[e.jsx(Pt,{className:"w-full max-w-xs",children:e.jsx(At,{})}),e.jsxs(Mt,{children:[e.jsx(Re,{value:"GPT 3",children:"GPT 3"}),e.jsx(Re,{value:"GPT 4",children:"GPT 4"})]})]})]})}),e.jsx("h3",{className:"text-md font-semibold",children:n("super_gmail.persona")}),e.jsx(fe,{control:s.control,name:"name",render:({field:f})=>e.jsxs(he,{children:[e.jsx(xe,{children:n("super_gmail.name")}),e.jsx(Le,{children:e.jsx(Ue,{placeholder:"Your name",...f})}),e.jsx(Pe,{})]})}),e.jsx("div",{className:"w-full max-w-sm",children:e.jsx(fe,{control:s.control,name:"bio",render:({field:f})=>e.jsxs(he,{children:[e.jsx(xe,{children:n("super_gmail.bio")}),e.jsx(Le,{children:e.jsx($e,{placeholder:n("super_gmail.bio_placeholder"),className:"resize-none",...f})}),e.jsx(Pe,{})]})})})]})})}),e.jsxs("div",{className:"text-md flex flex-col space-y-2 font-semibold",children:[e.jsx("div",{children:"Disable quill"}),e.jsxs(pt,{value:u,onValueChange:f=>m(f.valueOf()),children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ie,{value:"now",id:"now"}),e.jsx(ve,{htmlFor:"now",children:"For this session"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ie,{value:"this-site",id:"this-site"}),e.jsx(ve,{htmlFor:"this-site",children:"For this site"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ie,{value:"forever",id:"forever"}),e.jsx(ve,{htmlFor:"forever",children:"Forever"})]})]})]})]})]}),e.jsx(ce,{className:"flex h-[60px] justify-end gap-2",children:e.jsx(F,{onClick:()=>{s.handleSubmit(C)(),u&&(u==="now"?I():u==="this-site"?j():u==="forever"&&v())},children:n("super_gmail.save")})})]}):e.jsx("div",{className:"flex-center h-full",children:e.jsx($t,{})})})]})}function Ws(r){const{startNewChat:n,textareaRef:t}=te(),{liveSelectionActive:i,setCtx:u}=ee(w=>({liveSelectionActive:w.liveSelectionActive,setCtx:w.setCtx})),m=Z(),{relativeDiv:c,textarea:l}=r,s=a.useRef(null),[C,I]=a.useState(!0),[j,v]=a.useState(!1),g=a.useRef(`textarea-${z()}`),y=a.useRef(`quill-portal-${z()}`),[o,N]=a.useState(0),[f,h]=a.useState(0),[S,L]=a.useState(""),[P,U]=a.useState(!1),[H,p]=a.useState("CHAT");function b(w){l&&(l==null||l.focus(),ns(l,w),l==null||l.scrollTo({behavior:"smooth",top:l==null?void 0:l.scrollHeight}),_({eventName:"InsertButton",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/quill"}))}a.useEffect(()=>{t.current=l;const w=()=>{const k=c.getBoundingClientRect(),d=l.getBoundingClientRect();let E=0,T=0;const B=d.height<60,R=24;d.x>=k.x?E=d.x-k.x+d.width-R:d.x+d.width>=k.x&&d.x<=k.x?E=d.x+d.width-k.x-R:E=-(k.x-(d.x+d.width)+R),d.y>=k.y?T=d.y-k.y+d.height-R+(B?R-d.height/2-10:0):d.y+d.height>=k.y&&d.y<=k.y?T=d.y+d.height-k.y-R+(B?R-d.height/2-10:0):T=-(k.y-(d.y+d.height)+R-(B?R-d.height/2-10:0)),N(E),h(T)};w(),l.setAttribute("merlin-id",g.current);const A=new ResizeObserver(w);return A.observe(l),window.addEventListener("resize",w),window.addEventListener("scroll",w),document.addEventListener("scroll",w),window.addEventListener("wheel",w),()=>{A.disconnect(),window.removeEventListener("resize",w),window.removeEventListener("scroll",w),document.removeEventListener("scroll",w),window.removeEventListener("wheel",w)}},[]),a.useEffect(()=>{function w(d){d.key==="Escape"&&(d.preventDefault(),U(!1))}const k=Ie(d=>{const E=window.getSelection().toString().trim();E.length>0?i?u({obj:{selectedText:E},text:E}):L(E):L("")},100);return document.addEventListener("selectionchange",k),window.addEventListener("keydown",w),()=>{window.removeEventListener("keydown",w),document.removeEventListener("selectionchange",k)}},[P,i]),a.useEffect(()=>{P||n()},[P]),a.useEffect(()=>{const w=s.current;if(P){const A=d=>{const E=w.closest(".reactAppRoot");if(!E)return;const T=E.parentNode;if(!T||!(T instanceof ShadowRoot))return;const B=T.activeElement,R=w.querySelectorAll('button:not(:disabled), [href], input, select, textarea, [tabindex]:not([tabindex="-1"]):not(:disabled)'),G=Array.from(R).indexOf(B),K=R.length-1;if(d.key==="Tab"&&(d.shiftKey&&G===0?(d.preventDefault(),R[K].focus()):!d.shiftKey&&G===R.length-1&&(d.preventDefault(),R[0].focus())),d.key==="ArrowDown"||d.key==="ArrowRight"){if(!B){R[0].focus();return}d.preventDefault();const Q=G+1<R.length?G+1:0,x=R[Q];x&&x.focus()}if(d.key==="ArrowUp"||d.key==="ArrowLeft"){if(!B){R[K].focus();return}d.preventDefault();const Q=G-1>=0?G-1:R.length-1,x=R[Q];x&&x.focus()}},k=d=>{d.key==="Escape"&&U(!1)};return w.addEventListener("keydown",A),w.addEventListener("keydown",k),()=>{w.removeEventListener("keydown",A),w.removeEventListener("keydown",k)}}},[P]),a.useEffect(()=>{const w=A=>{const{data:k}=A;if(k.from&&k.from==="QUILL"){const{payload:d}=k;d&&d.action==="CLOSE_QUILL_THROUGHT_PAGE"&&I(!1)}};return window.addEventListener("message",w),()=>{window.removeEventListener("message",w)}},[]);function q(){return m.isAuthenticated?H==="SETTINGS"?e.jsx($s,{setCurrentMode:p}):e.jsx(e.Fragment,{children:e.jsx(Fs,{handleInsertText:b,setCurrentMode:p})}):e.jsx(As,{})}return C?e.jsxs("div",{style:{left:o,position:"absolute",top:f,zIndex:r.zIndex},children:[e.jsx(Ps,{isVisible:P,setModalOpen:v,setIsVisible:U,textarea:l,textareaId:g,selectedText:S}),e.jsx(Fe,{selector:{mountAsHtmlChild:!0},shouldMount:j,id:"quill-feedback-portal"+y.current,className:"merlin quill-feeback relative",groupBy:"quill-feeback-group",zIndex:2147483646,children:e.jsx(Ds,{modalOpen:j,setModalOpen:v})}),e.jsx(Fe,{selector:{mountAsHtmlChild:!0},shouldMount:P,id:y.current,className:"merlin quill-portal-ui relative",groupBy:"quill-portal-ui-group",zIndex:2147483646,children:e.jsxs(Ne,{className:D("fixed flex w-[448px] flex-col justify-between transition-[right] duration-300 ease-in-out",{"select-none":i}),style:{right:20,top:20,zIndex:2147483646},ref:s,children:[e.jsx("div",{className:"absolute -right-3 -top-3 cursor-pointer rounded-full bg-secondary p-1 shadow-lg",onClick:()=>U(!1),children:e.jsx(Ye,{className:"h-4 w-4"})}),q()]})})]}):null}const ft=(r,n)=>{let t=n;if(!r)return!0;switch(r.type){case"qs":if(!t.querySelector(r.value))return!1;break;case"parent":t=t.parentElement;break;case"hasClass":if(!t.classList.contains(r.value))return!1;break;case"closest":if(t=t.closest(r.value),!t)return!1;break;case"next":if(t=t.nextElementSibling,!t)return!1;break;case"prev":if(t=t.previousElementSibling,!t)return!1;break;case"firstChild":if(t=t.firstElementChild,!t)return!1;break;case"lastChild":if(t=t.lastElementChild,!t)return!1;break;case"hasId":if(!t.id||t.id!==r.value)return!1;break;case"hasAttribute":if(!t.hasAttribute(r.value))return!1;break}return r.hasOwnProperty("then")?ft(r.then,t):!0};function Ys(r){const{blacklistedAttributes:n,mountData:t}=r,[i,u]=J.useState([]),m=J.useRef(null);function c(l,s){try{const C=window.location.host,I=l.find(j=>j.host===C);if(I){const{mountingSchema:j}=I;j.forEach(v=>{document.querySelectorAll(v.selector).forEach(y=>{if(y.getAttribute("merlin-id"))return;if(ft(v.condition,y)){try{const N=window.getComputedStyle(y);if(N.visibility==="hidden"||N.display==="none")return;const f=y.getBoundingClientRect();if(f.width<100||f.height<10)return;if(y instanceof HTMLTextAreaElement||y instanceof HTMLInputElement){const h=Array.from(y.attributes).map(L=>L.value),S=Array.from(y.attributes).map(L=>L.name);if(h.some(L=>L.toLowerCase().includes("search"))||S.some(L=>L.toLowerCase().includes("search"))||y.readOnly)return}}catch{return}u(N=>{if(N.some(h=>h.id===y.id))return N;const f=window.getComputedStyle(y);return[...N,{id:z(),ref:y,zIndex:f.zIndex||10}]})}})})}else{const j=document.body.querySelectorAll("textarea"),v=document.body.querySelectorAll('[contenteditable="true"]'),g=document.body.querySelectorAll("input[type=text]:not([name=email])");Array.from(v).concat(Array.from(j)).concat(Array.from(g)).forEach(o=>{try{const f=window.getComputedStyle(o);if(f.visibility==="hidden"||f.display==="none")return;const h=o.getBoundingClientRect();if(h.width<100||h.height<10)return;if(o instanceof HTMLTextAreaElement||o instanceof HTMLInputElement){const S=Array.from(o.attributes).map(P=>P.value),L=Array.from(o.attributes).map(P=>P.name);if(S.some(P=>P.toLowerCase().includes("search"))||L.some(P=>P.toLowerCase().includes("search"))||o.readOnly)return}}catch{return}s.some(f=>o.getAttribute(f.key)===f.value)||o.getAttribute("merlin-id")||u(f=>{if(f.some(S=>S.id===o.id))return f;const h=window.getComputedStyle(o);return[...f,{id:z(),ref:o,zIndex:h.zIndex||10}]})})}}catch{}}return a.useEffect(()=>{c(t,n);const l=new MutationObserver(Ie(()=>{c(t,n)},50));return l.observe(document.body,{childList:!0,subtree:!0}),()=>{l.disconnect()}},[]),a.useEffect(()=>{},[i]),e.jsx("div",{className:"relative",ref:m,onMouseEnter:()=>_({eventName:"QuillButton",eventType:"HoverElement",feature:"Quill",firedFromFile:"features/quill/quillWrapper"}),children:i.map(l=>e.jsx(Ls,{children:e.jsx(Ws,{textarea:l.ref,relativeDiv:m.current,zIndex:l.zIndex})},l.id))})}const Js=async()=>{await new Promise(r=>{const n=new MutationObserver(Ie(()=>{document.body&&(r(),n.disconnect())},50));n.observe(document.documentElement,{childList:!0,subtree:!0})})};function Xs({blacklistedAttributes:r,mountData:n}){var i,u;return(u=(i=Ce().details)==null?void 0:i.quill)!=null&&u.isEnabled?e.jsx(yt,{children:e.jsx(Nt,{children:e.jsx(Ct,{children:e.jsx(Dt,{children:e.jsx(ss,{children:e.jsx(Ft,{isWebpage:!1,children:e.jsx(Ys,{mountData:n,blacklistedAttributes:r})})})})})})}):null}const Zs=async()=>{if(await as(je.QUILL))return;const n=await ts();if(!n||!n.visible)return;const t=window.location.host,i=n.listInUse;if(i==="blacklist"){const j=n.blacklist,v=n.blacklistType;if(v==="contains"&&j.some(g=>t.includes(g))||v==="exact"&&j.some(g=>t===g))return}else if(i==="whitelist"){const j=n.whitelist,v=n.whitelistType;if(v==="contains"&&!j.some(g=>t.includes(g))||v==="exact"&&!j.some(g=>t===g))return}const u=n.shouldUseMount?n.mount:[],m=n.blacklistedAttributes;await Js();const c=document.createElement("merlin-component");c.id="merlin-quill",c.className="merlin textarea-merlin";const l=c.attachShadow({mode:"open"}),s=document.createElement("style");s.textContent=`${ys}
  :host(#merlin-quill) {
  }
  .reactAppRoot {
    all: initial; /* 1st rule so subsequent properties are reset. */
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    position: absolute;
    top: 0;
    left: 0;
    z-index: ${t==="www.reddit.com"?10:2147483645};
  }
  .dark {
      ${Wt}
  }
  ${Yt}
  `.replaceAll(":root",":host"),l.appendChild(s);const C=document.createElement("div");C.id="reactAppRoot",C.className="reactAppRoot",wt.forEach(j=>{C.addEventListener(j,v=>{v.stopPropagation()})}),document.documentElement.prepend(c),l.appendChild(C),jt(C).render(e.jsx(Xs,{mountData:u,blacklistedAttributes:m}))};Zs();
