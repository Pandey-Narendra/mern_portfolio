import{r as w,j as a,i as rn}from"./localStorage-e41904e9.js";import{a as sn}from"./client-ebe67c58.js";import{c as q,q as rt,Q as It,R as an,S as on,T as Pt,J as _t,K as Et,V as ln,u as cn,a as Ft,F as gt,e as dn,G as un}from"./browserPolyfillWrapper-b0fafb12.js";import{C as fn,R as mn}from"./reactQueryProviderExtension-ed907ea6.js";import{T as pn}from"./themeContext-e2709bf1.js";import{S as hn}from"./merlin-logo-643be8a2.js";import{I as gn,p as xn,g as Pe,f as Ke,e as yn,a as vn,b as wn,u as bn,c as Sn,d as Z,h as jn,i as Nn,j as Ce,k as Cn}from"./vault.helpers-97c7ab65.js";import{d as kn}from"./debounce-c70d88e0.js";import{v as In}from"./IconCheck-d416f5fc.js";import{A as Ae,a as De,b as Me,e as Pn,c as _n,d as En,f as Fn,I as Tn,B as An}from"./accordion-05be2e35.js";import{u as Dn,c as G,B as oe}from"./button-e9a1516e.js";import{D as Mn,e as Rn,f as Ln,g as On,C as Un,a as Bn,b as Vn,c as zn,d as $n,h as Gn}from"./command-bf28c594.js";import{f as fe}from"./analytics-8361cfa0.js";import{c as Wn,d as Jn,P as Tt,a as xt,b as Hn,u as Kn}from"./index-773e7750.js";import{u as Qn,b as Xn,C as Yn}from"./index-8b63691d.js";import{c as st}from"./createReactComponent-8aad68f0.js";import{I as Zn}from"./IconArrowLeft-69432c7a.js";import{I as qn}from"./IconPlus-7368eea3.js";import{L as yt}from"./loader-circle-ade9dc52.js";import{c as er}from"./index-64a9bfa6.js";import{m as tr}from"./index-f612f062.js";import"./persist-4b6dccac.js";const Qe=new Map,ke=e=>{const t=Qe.get(e);return t?Object.fromEntries(Object.entries(t.stores).map(([r,n])=>[r,n.getState()])):{}},nr=(e,t,r)=>{if(e===void 0)return{type:"untracked",connection:t.connect(r)};const n=Qe.get(r.name);if(n)return{type:"tracked",store:e,...n};const s={connection:t.connect(r),stores:{}};return Qe.set(r.name,s),{type:"tracked",store:e,...s}},rr=(e,t={})=>(r,n,s)=>{const{enabled:i,anonymousActionType:l,store:c,...d}=t;let u;try{u=(i??!1)&&window.__REDUX_DEVTOOLS_EXTENSION__}catch{}if(!u)return e(r,n,s);const{connection:f,...o}=nr(c,u,d);let m=!0;s.setState=(y,v,b)=>{const C=r(y,v);if(!m)return C;const N=b===void 0?{type:l||"anonymous"}:typeof b=="string"?{type:b}:b;return c===void 0?(f==null||f.send(N,n()),C):(f==null||f.send({...N,type:`${c}/${N.type}`},{...ke(d.name),[c]:s.getState()}),C)};const p=(...y)=>{const v=m;m=!1,r(...y),m=v},g=e(s.setState,n,s);if(o.type==="untracked"?f==null||f.init(g):(o.stores[o.store]=s,f==null||f.init(Object.fromEntries(Object.entries(o.stores).map(([y,v])=>[y,y===o.store?g:v.getState()])))),s.dispatchFromDevtools&&typeof s.dispatch=="function"){let y=!1;const v=s.dispatch;s.dispatch=(...b)=>{v(...b)}}return f.subscribe(y=>{var v;switch(y.type){case"ACTION":if(typeof y.payload!="string"){console.error("[zustand devtools middleware] Unsupported action format");return}return $e(y.payload,b=>{if(b.type==="__setState"){if(c===void 0){p(b.state);return}Object.keys(b.state).length!==1&&console.error(`
                    [zustand devtools middleware] Unsupported __setState action format. 
                    When using 'store' option in devtools(), the 'state' should have only one key, which is a value of 'store' that was passed in devtools(),
                    and value of this only key should be a state object. Example: { "type": "__setState", "state": { "abc123Store": { "foo": "bar" } } }
                    `);const C=b.state[c];if(C==null)return;JSON.stringify(s.getState())!==JSON.stringify(C)&&p(C);return}s.dispatchFromDevtools&&typeof s.dispatch=="function"&&s.dispatch(b)});case"DISPATCH":switch(y.payload.type){case"RESET":return p(g),c===void 0?f==null?void 0:f.init(s.getState()):f==null?void 0:f.init(ke(d.name));case"COMMIT":if(c===void 0){f==null||f.init(s.getState());return}return f==null?void 0:f.init(ke(d.name));case"ROLLBACK":return $e(y.state,b=>{if(c===void 0){p(b),f==null||f.init(s.getState());return}p(b[c]),f==null||f.init(ke(d.name))});case"JUMP_TO_STATE":case"JUMP_TO_ACTION":return $e(y.state,b=>{if(c===void 0){p(b);return}JSON.stringify(s.getState())!==JSON.stringify(b[c])&&p(b[c])});case"IMPORT_STATE":{const{nextLiftedState:b}=y.payload,C=(v=b.computedStates.slice(-1)[0])==null?void 0:v.state;if(!C)return;p(c===void 0?C:C[c]),f==null||f.send(null,b);return}case"PAUSE_RECORDING":return m=!m}return}}),g},sr=rr,$e=(e,t)=>{let r;try{r=JSON.parse(e)}catch(n){console.error("[zustand devtools middleware] Could not parse the received json",n)}r!==void 0&&t(r)};var vt=st("folder","IconFolder",[["path",{d:"M5 4h4l3 3h7a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-11a2 2 0 0 1 2 -2",key:"svg-0"}]]),me=st("loader-2","IconLoader2",[["path",{d:"M12 3a9 9 0 1 0 9 9",key:"svg-0"}]]),ar=st("markdown","IconMarkdown",[["path",{d:"M3 5m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z",key:"svg-0"}],["path",{d:"M7 15v-6l2 2l2 -2v6",key:"svg-1"}],["path",{d:"M14 13l2 2l2 -2m-2 2v-6",key:"svg-2"}]]);function ir(){return w.useEffect(()=>{const e=[],t=document.createElement("div");t.style.display="none",document.body.appendChild(t);const r=t.attachShadow({mode:"open"}),n=document.createElement("style");n.textContent=gn,r.appendChild(n);function s(){document.querySelectorAll("img:not([data-merlin-processed])").forEach(l=>{l instanceof HTMLImageElement&&l.complete&&xn(l,e)})}s();const i=new MutationObserver(kn(l=>{l.forEach(c=>{c.removedNodes.length&&c.removedNodes.forEach(d=>{var u;if(d instanceof HTMLImageElement){const f=e.findIndex(o=>d.hasAttribute("data-merlin-processed"));f!==-1&&((u=e[f])==null||u.call(e),e.splice(f,1))}})}),s()},300));return i.observe(document.body,{childList:!0,subtree:!0}),()=>{t.remove(),i.disconnect(),e.forEach(l=>l())}},[]),null}var At=Symbol.for("immer-nothing"),wt=Symbol.for("immer-draftable"),O=Symbol.for("immer-state");function J(e,...t){throw new Error(`[Immer] minified error nr: ${e}. Full error at: https://bit.ly/3cXEKWf`)}var pe=Object.getPrototypeOf;function he(e){return!!e&&!!e[O]}function ce(e){var t;return e?Dt(e)||Array.isArray(e)||!!e[wt]||!!((t=e.constructor)!=null&&t[wt])||Le(e)||Oe(e):!1}var or=Object.prototype.constructor.toString();function Dt(e){if(!e||typeof e!="object")return!1;const t=pe(e);if(t===null)return!0;const r=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return r===Object?!0:typeof r=="function"&&Function.toString.call(r)===or}function _e(e,t){Re(e)===0?Reflect.ownKeys(e).forEach(r=>{t(r,e[r],e)}):e.forEach((r,n)=>t(n,r,e))}function Re(e){const t=e[O];return t?t.type_:Array.isArray(e)?1:Le(e)?2:Oe(e)?3:0}function Xe(e,t){return Re(e)===2?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function Mt(e,t,r){const n=Re(e);n===2?e.set(t,r):n===3?e.add(r):e[t]=r}function lr(e,t){return e===t?e!==0||1/e===1/t:e!==e&&t!==t}function Le(e){return e instanceof Map}function Oe(e){return e instanceof Set}function ie(e){return e.copy_||e.base_}function Ye(e,t){if(Le(e))return new Map(e);if(Oe(e))return new Set(e);if(Array.isArray(e))return Array.prototype.slice.call(e);const r=Dt(e);if(t===!0||t==="class_only"&&!r){const n=Object.getOwnPropertyDescriptors(e);delete n[O];let s=Reflect.ownKeys(n);for(let i=0;i<s.length;i++){const l=s[i],c=n[l];c.writable===!1&&(c.writable=!0,c.configurable=!0),(c.get||c.set)&&(n[l]={configurable:!0,writable:!0,enumerable:c.enumerable,value:e[l]})}return Object.create(pe(e),n)}else{const n=pe(e);if(n!==null&&r)return{...e};const s=Object.create(n);return Object.assign(s,e)}}function at(e,t=!1){return Ue(e)||he(e)||!ce(e)||(Re(e)>1&&(e.set=e.add=e.clear=e.delete=cr),Object.freeze(e),t&&Object.entries(e).forEach(([r,n])=>at(n,!0))),e}function cr(){J(2)}function Ue(e){return Object.isFrozen(e)}var dr={};function de(e){const t=dr[e];return t||J(0,e),t}var ve;function Rt(){return ve}function ur(e,t){return{drafts_:[],parent_:e,immer_:t,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function bt(e,t){t&&(de("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function Ze(e){qe(e),e.drafts_.forEach(fr),e.drafts_=null}function qe(e){e===ve&&(ve=e.parent_)}function St(e){return ve=ur(ve,e)}function fr(e){const t=e[O];t.type_===0||t.type_===1?t.revoke_():t.revoked_=!0}function jt(e,t){t.unfinalizedDrafts_=t.drafts_.length;const r=t.drafts_[0];return e!==void 0&&e!==r?(r[O].modified_&&(Ze(t),J(4)),ce(e)&&(e=Ee(t,e),t.parent_||Fe(t,e)),t.patches_&&de("Patches").generateReplacementPatches_(r[O].base_,e,t.patches_,t.inversePatches_)):e=Ee(t,r,[]),Ze(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e!==At?e:void 0}function Ee(e,t,r){if(Ue(t))return t;const n=t[O];if(!n)return _e(t,(s,i)=>Nt(e,n,t,s,i,r)),t;if(n.scope_!==e)return t;if(!n.modified_)return Fe(e,n.base_,!0),n.base_;if(!n.finalized_){n.finalized_=!0,n.scope_.unfinalizedDrafts_--;const s=n.copy_;let i=s,l=!1;n.type_===3&&(i=new Set(s),s.clear(),l=!0),_e(i,(c,d)=>Nt(e,n,s,c,d,r,l)),Fe(e,s,!1),r&&e.patches_&&de("Patches").generatePatches_(n,r,e.patches_,e.inversePatches_)}return n.copy_}function Nt(e,t,r,n,s,i,l){if(he(s)){const c=i&&t&&t.type_!==3&&!Xe(t.assigned_,n)?i.concat(n):void 0,d=Ee(e,s,c);if(Mt(r,n,d),he(d))e.canAutoFreeze_=!1;else return}else l&&r.add(s);if(ce(s)&&!Ue(s)){if(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1)return;Ee(e,s),(!t||!t.scope_.parent_)&&typeof n!="symbol"&&Object.prototype.propertyIsEnumerable.call(r,n)&&Fe(e,s)}}function Fe(e,t,r=!1){!e.parent_&&e.immer_.autoFreeze_&&e.canAutoFreeze_&&at(t,r)}function mr(e,t){const r=Array.isArray(e),n={type_:r?1:0,scope_:t?t.scope_:Rt(),modified_:!1,finalized_:!1,assigned_:{},parent_:t,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1};let s=n,i=it;r&&(s=[n],i=we);const{revoke:l,proxy:c}=Proxy.revocable(s,i);return n.draft_=c,n.revoke_=l,c}var it={get(e,t){if(t===O)return e;const r=ie(e);if(!Xe(r,t))return pr(e,r,t);const n=r[t];return e.finalized_||!ce(n)?n:n===Ge(e.base_,t)?(We(e),e.copy_[t]=tt(n,e)):n},has(e,t){return t in ie(e)},ownKeys(e){return Reflect.ownKeys(ie(e))},set(e,t,r){const n=Lt(ie(e),t);if(n!=null&&n.set)return n.set.call(e.draft_,r),!0;if(!e.modified_){const s=Ge(ie(e),t),i=s==null?void 0:s[O];if(i&&i.base_===r)return e.copy_[t]=r,e.assigned_[t]=!1,!0;if(lr(r,s)&&(r!==void 0||Xe(e.base_,t)))return!0;We(e),et(e)}return e.copy_[t]===r&&(r!==void 0||t in e.copy_)||Number.isNaN(r)&&Number.isNaN(e.copy_[t])||(e.copy_[t]=r,e.assigned_[t]=!0),!0},deleteProperty(e,t){return Ge(e.base_,t)!==void 0||t in e.base_?(e.assigned_[t]=!1,We(e),et(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0},getOwnPropertyDescriptor(e,t){const r=ie(e),n=Reflect.getOwnPropertyDescriptor(r,t);return n&&{writable:!0,configurable:e.type_!==1||t!=="length",enumerable:n.enumerable,value:r[t]}},defineProperty(){J(11)},getPrototypeOf(e){return pe(e.base_)},setPrototypeOf(){J(12)}},we={};_e(it,(e,t)=>{we[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}});we.deleteProperty=function(e,t){return we.set.call(this,e,t,void 0)};we.set=function(e,t,r){return it.set.call(this,e[0],t,r,e[0])};function Ge(e,t){const r=e[O];return(r?ie(r):e)[t]}function pr(e,t,r){var s;const n=Lt(t,r);return n?"value"in n?n.value:(s=n.get)==null?void 0:s.call(e.draft_):void 0}function Lt(e,t){if(!(t in e))return;let r=pe(e);for(;r;){const n=Object.getOwnPropertyDescriptor(r,t);if(n)return n;r=pe(r)}}function et(e){e.modified_||(e.modified_=!0,e.parent_&&et(e.parent_))}function We(e){e.copy_||(e.copy_=Ye(e.base_,e.scope_.immer_.useStrictShallowCopy_))}var hr=class{constructor(e){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(t,r,n)=>{if(typeof t=="function"&&typeof r!="function"){const i=r;r=t;const l=this;return function(d=i,...u){return l.produce(d,f=>r.call(this,f,...u))}}typeof r!="function"&&J(6),n!==void 0&&typeof n!="function"&&J(7);let s;if(ce(t)){const i=St(this),l=tt(t,void 0);let c=!0;try{s=r(l),c=!1}finally{c?Ze(i):qe(i)}return bt(i,n),jt(s,i)}else if(!t||typeof t!="object"){if(s=r(t),s===void 0&&(s=t),s===At&&(s=void 0),this.autoFreeze_&&at(s,!0),n){const i=[],l=[];de("Patches").generateReplacementPatches_(t,s,i,l),n(i,l)}return s}else J(1,t)},this.produceWithPatches=(t,r)=>{if(typeof t=="function")return(l,...c)=>this.produceWithPatches(l,d=>t(d,...c));let n,s;return[this.produce(t,r,(l,c)=>{n=l,s=c}),n,s]},typeof(e==null?void 0:e.autoFreeze)=="boolean"&&this.setAutoFreeze(e.autoFreeze),typeof(e==null?void 0:e.useStrictShallowCopy)=="boolean"&&this.setUseStrictShallowCopy(e.useStrictShallowCopy)}createDraft(e){ce(e)||J(8),he(e)&&(e=gr(e));const t=St(this),r=tt(e,void 0);return r[O].isManual_=!0,qe(t),r}finishDraft(e,t){const r=e&&e[O];(!r||!r.isManual_)&&J(9);const{scope_:n}=r;return bt(n,t),jt(void 0,n)}setAutoFreeze(e){this.autoFreeze_=e}setUseStrictShallowCopy(e){this.useStrictShallowCopy_=e}applyPatches(e,t){let r;for(r=t.length-1;r>=0;r--){const s=t[r];if(s.path.length===0&&s.op==="replace"){e=s.value;break}}r>-1&&(t=t.slice(r+1));const n=de("Patches").applyPatches_;return he(e)?n(e,t):this.produce(e,s=>n(s,t))}};function tt(e,t){const r=Le(e)?de("MapSet").proxyMap_(e,t):Oe(e)?de("MapSet").proxySet_(e,t):mr(e,t);return(t?t.scope_:Rt()).drafts_.push(r),r}function gr(e){return he(e)||J(10,e),Ot(e)}function Ot(e){if(!ce(e)||Ue(e))return e;const t=e[O];let r;if(t){if(!t.modified_)return t.base_;t.finalized_=!0,r=Ye(e,t.scope_.immer_.useStrictShallowCopy_)}else r=Ye(e,!0);return _e(r,(n,s)=>{Mt(r,n,Ot(s))}),t&&(t.finalized_=!1),r}var U=new hr,E=U.produce;U.produceWithPatches.bind(U);U.setAutoFreeze.bind(U);U.setUseStrictShallowCopy.bind(U);U.applyPatches.bind(U);U.createDraft.bind(U);U.finishDraft.bind(U);const Ct={isVisible:!1},xr=q(e=>({...Ct,closeDialog:()=>e({isVisible:!1}),openDialog:()=>e({isVisible:!0}),resetStore:()=>e(Ct)})),yr=["craft","canvas","merlinMagic","webAccess","file","largeContext"],vr=q()(sr((e,t)=>({activeNode:null,completedSteps:[],currentPath:[],currentStep:null,editorContent:"",error:null,fullPrompt:"",getCurrentPrompt:()=>{const r=t();return r.editorContent||Ie(r.currentPath)},getSuggestionsByInput:r=>{const n=t(),s=n.activeNode;if(!(s!=null&&s.children))return[];const i=n.currentPath.map(l=>l.text).join(" ");if(r.trim()===i)return s.children;if(r.startsWith(i)){const l=r.slice(i.length).trim();return l?s.children.filter(c=>c.text.toLowerCase().includes(l.toLowerCase())):s.children}return s.children},goBack:()=>{e(r=>{if(r.currentPath.length<=1)return t().resetFlow(),{activeNode:null,currentPath:[],editorContent:"",error:null,isFlowComplete:!1,isValid:!0,suggestions:[]};const n=r.currentPath.slice(0,-1),s=n.length>0?n[n.length-1]:null;return{activeNode:s??null,currentPath:n,editorContent:Ie(n),error:null,isFlowComplete:!1,isValid:!0,suggestions:(s==null?void 0:s.children)||[]}})},goToRoot:()=>{const r=t();if(r.currentPath.length===0){e({activeNode:null,currentPath:[],editorContent:"",error:null,isFlowComplete:!1,isValid:!0,suggestions:[]});return}const n=r.currentPath[0];n&&e({activeNode:n,currentPath:[n],editorContent:n.text,error:null,isFlowComplete:!1,isValid:!0,suggestions:n.children??[]})},handleNodeActions:async(r,n)=>{var i;if(!((i=r==null?void 0:r.metadata)!=null&&i.requiredParams))return;const s=r.metadata.requiredParams;if(s.model&&n!=="guest"){const l=await rt.fetchQuery(It.MerlinConstants)??an;let c;if(n==="free"?c=s.model.nonProUserModel:c=s.model.proUserModel,!l.textLLMs.find(u=>u.id===c)){console.error("Model not found:",c);return}window.__updateUserSettings({aiModel:c})}if(s.modes){const l=Object.entries(s.modes).reduce((c,[d,u])=>(yr.includes(d)&&u&&c.push(d),c),[]);l.includes("merlinMagic")?window.__updateUserSettings({merlinMagic:{isEnabled:!0}}):window.__updateUserSettings({merlinMagic:{isEnabled:!1}}),l.includes("webAccess")?window.__updateUserSettings({focusMode:{isEnabled:!1,mode:"youtube"},webAccess:{isEnabled:!0}}):window.__updateUserSettings({focusMode:{isEnabled:!1,mode:"youtube"},webAccess:{isEnabled:!1}})}},history:[],isFlowComplete:!1,isValid:!0,navigateToNode:r=>{const n=t(),s=n.currentPath.findIndex(i=>i.id===r);if(s!==-1){const i=n.currentPath.slice(0,s+1),l=i.length>0?i[i.length-1]:null;if(!l)return;e({activeNode:l,currentPath:i,editorContent:Ie(i),error:null,isFlowComplete:!1,isValid:!0,suggestions:l.children||[]})}},resetFlow:()=>{e({activeNode:null,currentPath:[],editorContent:"",error:null,history:[],isFlowComplete:!1,isValid:!0,suggestions:[]})},selectNode:(r,n)=>{e(s=>{var f,o;const i=[...s.currentPath,r],l=Ie(i),c=((f=r.metadata)==null?void 0:f.isTerminal)??!1;if(!wr(r,s.currentPath))return{error:"Invalid node selection in flow",isValid:!1};(o=r.metadata)!=null&&o.requiredParams&&t().handleNodeActions(r,n);const u=[...s.history,{content:l,path:i,timestamp:Date.now()}];return{activeNode:r,currentPath:i,editorContent:l,error:null,history:u,isFlowComplete:c,isValid:!0,suggestions:r.children||[]}})},suggestions:[],updateContent:r=>{e(n=>({editorContent:r,error:n.isValid?null:n.error}))},validateCurrentFlow:()=>{const r=t();return r.activeNode?r.isFlowComplete?br(r.activeNode,r.editorContent):Sr(r.currentPath):!1}}),{name:"quick-actions-store"}));function Ie(e){return e.map(t=>t.text).join(" ")}function wr(e,t){var n;if(t.length===0)return!0;const r=t[t.length-1];return((n=r==null?void 0:r.children)==null?void 0:n.some(s=>s.id===e.id))??!1}function br(e,t){var r;return(r=e.metadata)!=null&&r.validationRules?e.metadata.validationRules.every(n=>n(t)):!0}function Sr(e){var t;for(let r=1;r<e.length;r++){const n=e[r-1],s=e[r];if(!s||!((t=n==null?void 0:n.children)!=null&&t.some(i=>i.id===s.id)))return!1}return!0}const jr=q()(e=>({botSuggestionTipTapProps:null,isBotSelectionMenuVisible:!1,isInputShaking:!1,isPromptAreaExpanded:!1,isNotificationNudgeVisible:!1,isPromptSelectionMenuVisible:!1,lastSelectedContext:null,linkAttachments:[],linkAttachmentsRemoved:[],promptSuggestionTipTapProps:null,setLastSelectedContext:t=>e(r=>({lastSelectedContext:t})),setShouldShowDeepResearchBanner:t=>e(r=>({shouldShowDeepResearchBanner:t})),setSmallTextAreaCaretPosition:t=>e(r=>({smallTextAreaCaretPosition:t})),setTextWarningType:t=>e(r=>({textWarningType:t})),setUserPrompt:t=>e(r=>({userPrompt:t})),shouldShowDeepResearchBanner:!1,smallTextAreaCaretPosition:1,textWarningType:"none",tiptapEditorInstance:null,userPrompt:""})),nt=q()((e,t)=>{const r=typeof window<"u"?JSON.parse(localStorage.getItem("guestUsedMerlinMagic")??JSON.stringify(!1)):!1;return{autoScrollEnabled:!0,bottomDrawerContent:null,centerPanelContent:"children",chatFooterWrapperRef:w.createRef(),chatScrollableContainerRef:w.createRef(),chatScrollableContainerScrollAnchorRef:w.createRef(),computedTitle:null,currentFileAttachment:null,guestUsedMerlinMagic:r,hasBotDraft:!1,initialTab:void 0,isModelSelectionMenuVisible:!1,isScrollingDown:!1,largeContext:!1,leftPanelContent:null,leftSidebarContent:null,messageToRegenerate:null,modelSelectionFilter:"all",openNativeFileSelector:()=>{},regenerateOnSelect:!1,rightPanelContent:null,selectedBot:null,selectedMessageId:null,selectedMessageIndex:-1,setGuestUsedMerlinMagic:()=>{typeof window>"u"||(localStorage.setItem("guestUsedMerlinMagic",JSON.stringify(!0)),e({guestUsedMerlinMagic:!0}))},setModelSelectionFilter:n=>e({modelSelectionFilter:n}),setSelectedMessageId:n=>e({selectedMessageId:n}),setSideBarVisible:n=>e({sideBarVisible:n}),sideBarVisible:!1,showVaultLinkContent:!1,showVaultTextContent:!1,showVaultPreview:!1,showVaultSidebar:!1,togglePanel:(n,s)=>{n?window.innerWidth>=768?(t().bottomDrawerContent==="crafts"&&nt.setState({bottomDrawerContent:null}),s==="left"&&e({initialTab:n==="updateChatbot"?"preview":void 0,leftPanelContent:t().leftPanelContent!==n?n:null}),s==="right"&&e({rightPanelContent:t().rightPanelContent!==n?n:null}),s==="bottom"&&e({bottomDrawerContent:t().bottomDrawerContent!==n?n:null})):(t().rightPanelContent==="crafts"&&nt.setState({rightPanelContent:null}),e({bottomDrawerContent:t().bottomDrawerContent!==n?n:null})):(s==="left"&&e({leftPanelContent:null}),s==="right"&&e({rightPanelContent:null}),s==="bottom"&&e({bottomDrawerContent:null}))},updateScrollPosition:null}}),Nr=(e,t)=>({activeThread:[],appendMessageThread:r=>{var n;r[0].parentId||(r[0].parentId=((n=t().activeThread[t().activeThread.length-1])==null?void 0:n.id)??"root"),r.forEach((s,i)=>{i>0&&(s.parentId=r[i-1].id)}),r.forEach(s=>{t().chatRef.set(s.id,{...s,activeChildIdx:0}),t().chatRef.get(s.parentId).childrenId.push(s.id)}),t().buildThread("root")},buildThread:r=>{const n=t().activeThread.findIndex(l=>l.id===r);let s=[];n!==-1&&(s=t().activeThread.filter((l,c)=>c<=n));const i=[];for(;r;){const l=t().chatRef.get(r).childrenId.map(c=>t().chatRef.get(c));if(l.length>0){const c=t().chatRef.get(r).activeChildIdx,d=l[c];i.push({...d,idx:c,totSiblings:t().chatRef.get(r).childrenId.length}),r=d==null?void 0:d.id}else r=null}e(()=>({activeThread:[...s,...i]}))},chatRef:new Map([["root",{activeChildIdx:0,attachments:[],childrenId:[],content:"",id:"root",idx:0,parentId:null,role:"system",status:"SUCCESS",timestamp:1714120666404,totSiblings:0}]]),deleteLastMessage:()=>{const r=Array.from(t().chatRef.values()).pop(),n=t().chatRef.get(r.id);if(t().chatRef.delete(r.id),!n)return null;const s=t().chatRef.get(n.parentId);return s.childrenId=s.childrenId.filter(i=>i!==n.id),s.activeChildIdx>=s.childrenId.length&&(s.activeChildIdx=s.childrenId.length-1<0?0:s.childrenId.length-1),t().buildThread("root"),{...n,idx:0,totSiblings:0}},editMessageNodeById:(r,n)=>{const s=t().chatRef.get(r);t().chatRef.set(r,n(s)),t().buildThread("root")},getLastMessage:()=>Array.from(t().chatRef.values()).pop(),init:()=>{t().chatRef.forEach((n,s)=>t().chatRef.set(s,{...n,activeChildIdx:0}));let r=null;for(t().chatRef.forEach((n,s)=>{(r===null||n.timestamp>=r.timestamp)&&(r=n)});r.parentId;){const n=t().chatRef.get(r.parentId);t().chatRef.set(r.parentId,{...n,activeChildIdx:n.childrenId.indexOf(r.id)}),r=t().chatRef.get(r.parentId)}t().buildThread("root")},insertMessageNode:(r,n)=>{e(i=>({chatRef:new Map([...i.chatRef,[n.id,{...n,activeChildIdx:0}]])}));const s=t().chatRef.get(r);s.childrenId.push(n.id),s.activeChildIdx=s.childrenId.length-1,t().buildThread(r)},insertMessageThread:(r,n)=>{var i;n[0].parentId||(n[0].parentId=((i=t().activeThread[t().activeThread.length-1])==null?void 0:i.id)??"root"),n.forEach((l,c)=>{c>0&&(l.parentId=n[c-1].id)}),n.forEach(l=>{t().chatRef.set(l.id,{...l,activeChildIdx:0}),t().chatRef.get(l.parentId).childrenId.push(l.id)});const s=t().chatRef.get(r);s.activeChildIdx=s.childrenId.length-1,t().buildThread(r)},reInitialize:r=>{const n=new Map(Object.entries(r));n.forEach(s=>{s.timestamp=new Date(s.timestamp).getTime()}),e(()=>({chatRef:n})),e({lastPromptInHeader:null}),t().init()},switchLeft:r=>{const n=t().chatRef.get(r.parentId);n.activeChildIdx>0&&(n.activeChildIdx-=1,t().buildThread(r.parentId))},switchRight:r=>{const n=t().chatRef.get(r.parentId);n.activeChildIdx<n.childrenId.length-1&&(n.activeChildIdx+=1,t().buildThread(r.parentId))},totalMessages:()=>{var r;return((r=t().chatRef)==null?void 0:r.size)-1}}),Cr=e=>({attachmentsUploadedByUser:[],chatbot:null,chatbotInteractionThread:!1,chatId:null,error:null,focusMode:void 0,lastPromptInHeader:null,model:{charge:"1x Query",default:!0,defaultPro:!1,description:"OpenAI's most scalable and fast model.",id:"gpt-3.5-turbo",name:"GPT 3.5",paid:!1,queryCost:1},project:null,questions:[],isDeepResearchEnabled:!1,resetChat:()=>{e({chatId:null}),e({lastPromptInHeader:null}),Hr.getState().resetStore(),Jt.getState().resetStore(),vr.getState().resetFlow(),be.setState({activeThread:[],chatRef:new Map([["root",{activeChildIdx:0,attachments:[],childrenId:[],content:"",id:"root",idx:0,parentId:null,role:"system",status:"SUCCESS",timestamp:1714120666404,totSiblings:0}]]),project:null,questions:[],sharing:null}),jr.setState({isNotificationNudgeVisible:!1,lastSelectedContext:null}),nt.setState({rightPanelContent:null,selectedMessageId:null})},sharing:null,title:"Chat with Merlin Ai!",webAccess:!1}),be=q()((...e)=>({...Nr(...e),...Cr(...e)}));function Ut(e){return"file"in e}function Bt(e){return"connectedAppType"in e}function xe(e){return"isImportFromMerlin"in e}function Vt(e){return"modelId"in e}function kr(e){return"url"in e}function zt(e){return"attachmentType"in e&&e.attachmentType==="WEB_PAGE"}function Se(e){return Ut(e)&&!Bt(e)&&!xe(e)&&!Vt(e)}function ge(e){return xe(e)&&!Ut(e)}function je(e){return kr(e)&&!xe(e)&&!zt(e)}function Be(e){return zt(e)&&!xe(e)}function Ve(e){return Bt(e)&&!xe(e)}function ze(e){return Vt(e)&&!xe(e)}function $t(e){return e.fileDetails!==null&&Se(e.fileDetails)}function Ir(e){return e.fileDetails!==null&&je(e.fileDetails)}function Pr(e){return e.fileDetails!==null&&Ve(e.fileDetails)}function Gt(e){return e.fileDetails!==null&&ze(e.fileDetails)}function Wt(e){return e.fileDetails!==null&&ge(e.fileDetails)}const Je=10,_r=2e3,Er=5,He={abortController:null,analysingProgress:0,detailsForChat:null,fileDetails:null,fileStoreId:"",signedUrlResponse:null,status:"pending",uploadProgress:0},kt={abortController:null,analysingProgress:0,detailsForChat:null,fileDetails:null,fileStoreId:"",signedUrlResponse:null,status:"pending"},Fr={abortController:null,analysingProgress:0,detailsForChat:null,fileDetails:null,fileStoreId:"",signedUrlResponse:null,status:"pending"};function Te(e){return ze(e)?`${e.prompt}-${e.id}`:je(e)||Be(e)?`${e.title}-${e.id}`:ge(e)?`${(e==null?void 0:e.fileName)||(e==null?void 0:e.name)||(e==null?void 0:e.title)}-${e.id}`:`${e.name}-${e.id}`}function ot(e){var t,r;return Et.isCancel(e)?"Upload cancelled":e instanceof ln?((r=(t=e.response)==null?void 0:t.data)==null?void 0:r.message)||e.message:"An unexpected error occurred"}function Tr(e){return e.replace("GLOBAL_","")}function Ar(e){if(!je(e))throw new Error("Invalid link attachment");if(!e)throw new Error("Invalid file details");return{dom:"",from:"",id:e.id,metadata:{hasFailed:!1,isUploading:!1,yetToBeSentOnce:!0},searchQueryForWebAccess:"",shouldCreateEmbeddings:!0,shouldScrapeOnCloud:!0,textContent:e.title,title:e.title,type:e.type,url:e.url}}function Dr(e){if(!Be(e))throw new Error("Invalid web page attachment");if(!e)throw new Error("Invalid file details");return{id:e.id,type:e.attachmentType,url:e.url,title:e.title,dom:e.dom,textContent:e.textContent}}function Mr(e){if(!Ve(e))throw new Error("Invalid connected app attachment");if(!e)throw new Error("Invalid file details");return{connectedAppFileId:e.connectedAppFileId,connectedAppType:e.connectedAppType,fileName:e.name,id:e.id,mimeType:e.type,type:e.attachmentType}}function Rr(e){if(!Gt(e)&&!e.fileDetails)throw new Error("Invalid generated image details");if(!e.fileDetails)throw new Error("Invalid file details");return{fileName:e.fileDetails.prompt,gcsId:e.fileDetails.gcsId,generationId:e.fileDetails.generationId||"",height:e.fileDetails.height,id:e.fileDetails.id,mimeType:e.fileDetails.mimeType,modelId:e.fileDetails.modelId,nsfw:e.fileDetails.nsfw,prompt:e.fileDetails.prompt,status:e.fileDetails.status,textContent:e.fileDetails.textContent,type:e.fileDetails.attachmentType,url:e.fileDetails.url,width:e.fileDetails.width}}function Lr(e){if(!$t(e)||!e.signedUrlResponse&&!e.fileDetails)throw new Error("Invalid file details");if(!e.fileDetails)throw new Error("Invalid file details");return{fileName:e.fileDetails.name,gcsId:e.signedUrlResponse.fileName,id:e.fileDetails.id,mimeType:e.fileDetails.type,type:e.fileDetails.attachmentType,url:e.signedUrlResponse.url}}function Or(e){if(!Wt(e))throw new Error("Invalid file details");if(!e.fileDetails)throw new Error("Invalid file details");return e.fileDetails}function Ur(){let e=be.getState().chatId;return e||(e=In(),be.setState({chatId:e})),e}function Br(e){if(!e.fileDetails)throw new Error("Missing file data");if(ge(e.fileDetails))return Or(e);if(ze(e.fileDetails))return Rr(e);if(je(e.fileDetails))return Ar(e.fileDetails);if(Be(e.fileDetails))return Dr(e.fileDetails);if(Ve(e.fileDetails))return Mr(e.fileDetails);if(Se(e.fileDetails))return Lr(e);throw new Error("Unknown attachment type")}async function Vr(e,t,r){var f,o,m,p,g,y,v,b,C,N;if(!e.fileDetails)throw new Error("Missing file details");const n=(o=(f=e.fileDetails)==null?void 0:f.attachmentType)==null?void 0:o.includes("GLOBAL"),s=(p=(m=e.fileDetails)==null?void 0:m.attachmentType)==null?void 0:p.includes("CONNECTED");let i=t.type;if(s&&n&&(i=Tr(i)),ge(e.fileDetails)){const{createdAt:k,createdByUserId:ee,isImportFromMerlin:te,metadata:F,projectId:T,source:P,updatedAt:H,usedInProjects:A,...B}=t;t={...B,type:e.fileDetails.attachmentType}}const{metadata:l,...c}=t,d={attachment:{...c,type:i},language:"ENGLISH"};return((g=e.fileDetails)==null?void 0:g.source)==="CHAT"&&(d.chatId=Ur()),((y=e.fileDetails)==null?void 0:y.source)==="PROJECT"&&(d.projectId=(v=be.getState().project)==null?void 0:v.id),((b=e.fileDetails)==null?void 0:b.source)==="PROJECT"&&(d.projectId=(r==null?void 0:r.projectId)||((C=be.getState().project)==null?void 0:C.id)),ge(e.fileDetails)&&(d.isImportFromMerlin=!0),(await Pt.post("/v2/user/upload",d,{signal:(N=e.abortController)==null?void 0:N.signal})).data.data}async function zr(e,t,r){if(!e.fileDetails)throw new Error("Missing file data");const n=Br(e);t(E(i=>{const l=i.currentFiles[e.fileStoreId];l&&(l.status="analysing",l.analysingProgress=0)}));const s=setInterval(()=>{t(E(i=>{const l=i.currentFiles[e.fileStoreId];l&&l.status==="analysing"&&(l.analysingProgress=Math.min(95,l.analysingProgress+Er))}))},_r);try{const i=await Vr(e,n,r),{attachment:l}=i;Wt(e)?t(E(c=>{const d=c.currentFiles[e.fileStoreId];if(d&&"fileDetails"in d){d.fileDetails={...e.fileDetails},d.signedUrlResponse={contentType:l.mimeType,fileName:l.fileName,id:l.id,url:l.url};const{createdAt:u,createdByUserId:f,metadata:o,projectId:m,source:p,summary:g,updatedAt:y,version:v,...b}=l;d.detailsForChat=b,d.analysingProgress=100,d.status="completed"}})):t(E(c=>{const d=c.currentFiles[e.fileStoreId];d&&(d.detailsForChat=n,d.analysingProgress=100,d.status="completed")}))}finally{clearInterval(s)}}async function $r(e,t){var r;if(!e.signedUrlResponse||!e.fileDetails||!("file"in e.fileDetails))throw new Error("Missing file data");t(E(n=>{const s=n.currentFiles[e.fileStoreId];s&&(s.status="uploading",s.uploadProgress=0)}));try{await Et.put(e.signedUrlResponse.url,e.fileDetails.file,{headers:{"Content-Type":e.fileDetails.type},signal:(r=e.abortController)==null?void 0:r.signal}),t(E(n=>{const s=n.currentFiles[e.fileStoreId];s&&(s.uploadProgress=100,s.status="analysing")}))}catch(n){throw t(E(s=>{const i=s.currentFiles[e.fileStoreId];i&&(i.status="failed",i.error=ot(n))})),n}}async function Gr(e,t){if(e.length===0)return;const n=e.filter(Se).map(s=>({id:s.id,name:s.name,type:s.type}));try{const s=await Pt.post("/v1/user/getPresignedUrl",{files:n});if(s.data.status==="error")throw new Error(s.data.data.message);const{signedUrls:i}=s.data.data;t(E(l=>{e.forEach(c=>{const d=Te(c),u=l.currentFiles[d];u&&(u.signedUrlResponse=i[c.id],u.status="gettingPresignedUrl",l.queue.push(d))})}))}catch(s){console.error("Error during file upload:",s);const i=ot(s);t(E(l=>{e.forEach(c=>{const d=Te(c),u=l.currentFiles[d];u&&u.status==="gettingPresignedUrl"&&(u.status="failed",u.error=i)})}))}}function Wr(e){e(E(t=>{t.hasStorageLimitError=!0,t.queue.forEach(r=>{var s;const n=t.currentFiles[r];n&&n.status!=="completed"&&(n.status="failed",n.error="Storage limit exceeded",(s=n.abortController)==null||s.abort())}),t.queue=[],Object.values(t.currentFiles).forEach(r=>{var n;(r.status==="uploading"||r.status==="analysing"||r.status==="gettingPresignedUrl"||r.status==="pending")&&(r.status="failed",r.error="Storage limit exceeded",(n=r.abortController)==null||n.abort())})})),_t.error("Storage limit exceeded",{action:{label:"Manage storage",onClick:()=>{xr.getState().openDialog()}},description:"Please delete some files to free up space.",duration:1/0,id:"storage-limit-error"}),setTimeout(()=>{e(E(t=>{Object.keys(t.currentFiles).forEach(r=>{const n=t.currentFiles[r];n.status==="failed"&&n.error==="Storage limit exceeded"&&delete t.currentFiles[r]})}))},3e3)}async function Jr(e,t,r){var n,s,i,l,c,d;for(;;){if(t().hasStorageLimitError)return;let u;if(e(E(o=>{o.hasStorageLimitError||(u=o.queue.shift(),u&&o.activeUploads++)})),!u)return;const f=t().currentFiles[u];if(!f){e(E(o=>{o.activeUploads--}));continue}try{Gt(f)||($t(f)?f.status==="gettingPresignedUrl"&&await $r(f,e):Ir(f)||Pr(f)),await zr(f,e,r)}catch(o){console.error("Upload/Analysis error:",o);const m=((i=(s=(n=o==null?void 0:o.response)==null?void 0:n.data)==null?void 0:s.data)==null?void 0:i.type)==="STORAGE_LIMIT_EXCEEDED";if(e(E(p=>{const g=p.currentFiles[u];g&&(g.status="failed",g.error=m?"Storage limit exceeded":ot(o)),p.activeUploads--})),m){Wr(e);return}else{const p=((d=(c=(l=o==null?void 0:o.response)==null?void 0:l.data)==null?void 0:c.data)==null?void 0:d.message)||(o==null?void 0:o.message)||"Failed to process file. Please try again.";_t.error(p),setTimeout(()=>{e(E(g=>{delete g.currentFiles[u]}))},3e3)}continue}e(E(o=>{o.activeUploads--}))}}function lt(){return(e,t)=>({activeUploads:0,allUploadsComplete:!1,currentFiles:{},hasStorageLimitError:!1,maxConcurrentUploads:Je,queue:[],remove:r=>e(E(n=>{const s=n.currentFiles[r];s!=null&&s.abortController&&s.abortController.abort(),delete n.currentFiles[r],n.queue=n.queue.filter(i=>i!==r)})),resetStore:()=>e({activeUploads:0,allUploadsComplete:!1,currentFiles:{},hasStorageLimitError:!1,maxConcurrentUploads:Je,queue:[]}),start:async(r,n)=>{const s=r.filter(Se);e(E(f=>{r.forEach(o=>{const m=Te(o);let p;if(ge(o))p={...He,fileDetails:{...o},fileStoreId:m,status:"pending"};else if(Se(o)){const y=o.source==="VAULT"?"pending":"gettingPresignedUrl";p={...He,fileDetails:o,fileStoreId:m,status:y}}else if(ze(o))p={...He,fileDetails:o,fileStoreId:m,status:"pending"};else if(je(o))p={...kt,fileDetails:o,fileStoreId:m,status:"pending"};else if(Be(o))p={...kt,fileDetails:o,fileStoreId:m,status:"pending"};else if(Ve(o))p={...Fr,fileDetails:o,fileStoreId:m,status:"pending"};else throw new Error("Unknown attachment type");f.currentFiles[m]=p})})),s.length>0&&await Gr(s,e),e(E(f=>{r.forEach(o=>{const m=Te(o);f.currentFiles[m]&&f.currentFiles[m].status==="pending"&&f.queue.push(m)})}));const i=[];for(let f=0;f<Je;f++)i.push(Jr(e,t,n));await Promise.all(i);const{currentFiles:l,hasStorageLimitError:c,queue:d}=t(),u=Object.values(l).every(f=>f.status==="completed"||f.status==="failed")&&d.length===0;!c&&u&&rt.invalidateQueries({queryKey:on.VaultItems.queryKey}),e({allUploadsComplete:u})}})}const Hr=q()(lt()),Jt=q()(lt()),Kr=q()(lt());var ct="Checkbox",[Qr,Es]=Wn(ct),[Xr,Yr]=Qr(ct),Ht=w.forwardRef((e,t)=>{const{__scopeCheckbox:r,name:n,checked:s,defaultChecked:i,required:l,disabled:c,value:d="on",onCheckedChange:u,...f}=e,[o,m]=w.useState(null),p=Dn(t,N=>m(N)),g=w.useRef(!1),y=o?!!o.closest("form"):!0,[v=!1,b]=Jn({prop:s,defaultProp:i,onChange:u}),C=w.useRef(v);return w.useEffect(()=>{const N=o==null?void 0:o.form;if(N){const k=()=>b(C.current);return N.addEventListener("reset",k),()=>N.removeEventListener("reset",k)}},[o,b]),a.jsxs(Xr,{scope:r,state:v,disabled:c,children:[a.jsx(Tt.button,{type:"button",role:"checkbox","aria-checked":le(v)?"mixed":v,"aria-required":l,"data-state":Xt(v),"data-disabled":c?"":void 0,disabled:c,value:d,...f,ref:p,onKeyDown:xt(e.onKeyDown,N=>{N.key==="Enter"&&N.preventDefault()}),onClick:xt(e.onClick,N=>{b(k=>le(k)?!0:!k),y&&(g.current=N.isPropagationStopped(),g.current||N.stopPropagation())})}),y&&a.jsx(Zr,{control:o,bubbles:!g.current,name:n,value:d,checked:v,required:l,disabled:c,style:{transform:"translateX(-100%)"}})]})});Ht.displayName=ct;var Kt="CheckboxIndicator",Qt=w.forwardRef((e,t)=>{const{__scopeCheckbox:r,forceMount:n,...s}=e,i=Yr(Kt,r);return a.jsx(Hn,{present:n||le(i.state)||i.state===!0,children:a.jsx(Tt.span,{"data-state":Xt(i.state),"data-disabled":i.disabled?"":void 0,...s,ref:t,style:{pointerEvents:"none",...e.style}})})});Qt.displayName=Kt;var Zr=e=>{const{control:t,checked:r,bubbles:n=!0,...s}=e,i=w.useRef(null),l=Qn(r),c=Kn(t);return w.useEffect(()=>{const d=i.current,u=window.HTMLInputElement.prototype,o=Object.getOwnPropertyDescriptor(u,"checked").set;if(l!==r&&o){const m=new Event("click",{bubbles:n});d.indeterminate=le(r),o.call(d,le(r)?!1:r),d.dispatchEvent(m)}},[l,r,n]),a.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:le(r)?!1:r,...s,tabIndex:-1,ref:i,style:{...e.style,...c,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function le(e){return e==="indeterminate"}function Xt(e){return le(e)?"indeterminate":e?"checked":"unchecked"}var Yt=Ht,qr=Qt;const ue=w.forwardRef(({className:e,...t},r)=>a.jsx(Yt,{ref:r,className:G("peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",e),...t,children:a.jsx(qr,{className:G("flex items-center justify-center text-current"),children:a.jsx(Xn,{className:"h-4 w-4"})})}));ue.displayName=Yt.displayName;const es=({content:e,getFileSelectionLimit:t,isAtLimit:r,onContentSelect:n,selectedContent:s,setSelectedContent:i})=>{const l=w.useMemo(()=>e.filter(u=>u.type==="image"),[e]),c=u=>{if(!u&&s){const g=[...s];s.forEach((y,v)=>{y.type==="image"&&(g[v]={...y,selected:!1})}),i(g);return}const f=s.filter(g=>g.selected&&g.type!=="image").length,o=t()-f;if(o<=0)return;const m=[...s];let p=0;s.forEach((g,y)=>{g.type==="image"&&p<o&&(m[y]={...g,selected:!0},p++)}),i(m)},d=w.useMemo(()=>l.every(u=>{var f;return(f=s[s.findIndex(o=>o===u)])==null?void 0:f.selected}),[l,s]);return l.length?a.jsxs(Ae,{value:"image",className:"mb-2 last:mb-0",children:[a.jsx(De,{className:G("bg-card px-3 py-2 shadow-sm hover:bg-muted/50 hover:no-underline","data-[state=closed]:rounded-lg data-[state=open]:rounded-t-lg"),children:a.jsxs("div",{className:"flex w-full items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(ue,{checked:d,onCheckedChange:c,disabled:r&&!d,onClick:u=>u.stopPropagation(),className:"data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground"}),a.jsx("span",{className:"font-medium",children:"Images found in selection"})]}),a.jsx("span",{className:"text-sm text-muted-foreground",children:l.length??0})]})}),a.jsx(Me,{children:a.jsx("div",{className:"mt-0 w-full overflow-hidden rounded-b-lg bg-muted/5 p-4 shadow-sm",children:a.jsx("div",{className:"grid grid-cols-3 gap-4",children:l.map((u,f)=>{const o=s.findIndex(p=>p===u)??-1;if(o===-1)return null;const m=Pe(u.content,"image",{alt:u.name||"",src:u.content});return a.jsxs("div",{className:"flex flex-col gap-2",children:[a.jsxs("div",{className:"relative aspect-square cursor-pointer rounded-lg border bg-card transition-colors hover:bg-muted/50",onClick:()=>n==null?void 0:n(u,o),children:[a.jsx(ue,{checked:u.selected,onCheckedChange:p=>{if(r&&!u.selected)return;const g=[...s];g[o]={...u,name:m,selected:!!p},i(g)},className:"absolute right-2 top-2 z-10 border-secondary bg-secondary text-primary shadow-sm backdrop-blur-sm",disabled:r&&!u.selected}),a.jsx("img",{src:u.content,alt:"",className:"absolute inset-0 h-full w-full rounded-lg object-cover"})]}),a.jsx("div",{className:"truncate px-1 text-center text-xs text-muted-foreground",children:m})]},f)})})})})]}):null},ts=({content:e,getFileSelectionLimit:t,isAtLimit:r,onContentSelect:n,selectedContent:s,setSelectedContent:i})=>{const l=w.useMemo(()=>e.filter(u=>u.type==="link"),[e]),c=u=>{if(!u&&s){const g=[...s];s.forEach((y,v)=>{y.type==="link"&&(g[v]={...y,selected:!1})}),i(g);return}const f=s.filter(g=>g.selected&&g.type!=="link").length,o=t()-f;if(o<=0)return;const m=[...s];let p=0;s.forEach((g,y)=>{g.type==="link"&&p<o&&(m[y]={...g,selected:!0},p++)}),i(m)},d=w.useMemo(()=>l.every(u=>{var f;return(f=s[s.findIndex(o=>o===u)])==null?void 0:f.selected}),[l,s]);return l.length?a.jsxs(Ae,{value:"link",className:"mb-2 last:mb-0",children:[a.jsx(De,{className:G("bg-card px-3 py-2 shadow-sm hover:bg-muted/50 hover:no-underline","data-[state=closed]:rounded-lg data-[state=open]:rounded-t-lg"),children:a.jsxs("div",{className:"flex w-full items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(ue,{checked:d,onCheckedChange:c,disabled:r&&!d,onClick:u=>u.stopPropagation(),className:"data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground"}),a.jsx("span",{className:"font-medium",children:"Links found in selection"})]}),a.jsx("span",{className:"text-sm text-muted-foreground",children:l.length??0})]})}),a.jsx(Me,{children:a.jsx("div",{className:"mt-0 w-full overflow-hidden rounded-b-lg bg-muted/5 p-4 shadow-sm",children:a.jsx("div",{className:"space-y-3",children:l.map((u,f)=>{try{const o=s.findIndex(m=>m===u)??-1;return o===-1?null:a.jsx("div",{className:G("rounded-lg border bg-card p-3 transition-colors hover:bg-muted/50"),onClick:()=>n==null?void 0:n(u,o),children:a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsx(ue,{checked:u.selected,onCheckedChange:m=>{if(r&&!u.selected)return;const p=[...s];p[o]={...u,selected:!!m},i(p)},className:"mt-1",disabled:r&&!u.selected}),a.jsxs("div",{className:"flex-1 space-y-1 overflow-hidden",children:[a.jsx("div",{className:"w-full cursor-pointer overflow-hidden font-medium text-primary hover:underline",onClick:m=>{m.stopPropagation(),window.open(u.content,"_blank")},children:Ke(u.content)}),a.jsx("div",{className:"text-xs text-muted-foreground",children:new URL(u.content).hostname})]})]})},f)}catch{return null}})})})})]}):null},ns=({content:e,expandedTexts:t,getFileSelectionLimit:r,isAtLimit:n,onContentSelect:s,selectedContent:i,setExpandedTexts:l,setSelectedContent:c})=>{const d=w.useMemo(()=>e.filter(o=>o.type==="markdown"),[e]),u=o=>{if(!o&&i){const v=[...i];i.forEach((b,C)=>{b.type==="markdown"&&(v[C]={...b,selected:!1})}),c(v);return}const m=i.filter(v=>v.selected&&v.type!=="markdown").length,p=r()-m;if(p<=0)return;const g=[...i];let y=0;i.forEach((v,b)=>{v.type==="markdown"&&y<p&&(g[b]={...v,selected:!0},y++)}),c(g)},f=w.useMemo(()=>d.every(o=>{var m;return(m=i[i.findIndex(p=>p===o)])==null?void 0:m.selected}),[d,i]);return d.length?a.jsxs(Ae,{value:"markdown",className:"mb-2 last:mb-0",children:[a.jsx(De,{className:G("bg-card px-3 py-2 shadow-sm hover:bg-muted/50 hover:no-underline","data-[state=closed]:rounded-lg data-[state=open]:rounded-t-lg"),children:a.jsxs("div",{className:"flex w-full items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(ue,{checked:f,onCheckedChange:u,disabled:n&&!f,onClick:o=>o.stopPropagation(),className:"data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground"}),a.jsx("span",{className:"font-medium",children:"Markdown found in selection"})]}),a.jsxs("span",{className:"text-sm text-muted-foreground",children:[d.map(o=>o.content.split(" ").length).reduce((o,m)=>o+m,0)??0," ","Words"," "]})]})}),a.jsx(Me,{children:a.jsx("div",{className:"mt-0 w-full overflow-hidden rounded-b-lg bg-muted/5 p-4 shadow-sm",children:a.jsx("div",{className:"space-y-3",children:d.map((o,m)=>{const p=i.findIndex(y=>y===o)??-1;if(p===-1)return null;const g=t[p]??!1;return a.jsx("div",{className:"rounded-lg border bg-card p-3 transition-colors hover:bg-muted/50",onClick:()=>s==null?void 0:s(o,p),children:a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("div",{className:G(!g&&"max-h-[100px] overflow-hidden"),children:a.jsx(Yn,{content:o.content})}),o.content.length>200&&a.jsx(oe,{variant:"ghost",size:"sm",className:"w-fit px-0 text-xs hover:bg-transparent",onClick:y=>{y.stopPropagation(),l(v=>({...v,[p]:!g}))},children:g?"Show Less":"Show More"})]})},m)})})})})]}):null},rs=({content:e,expandedTexts:t,getFileSelectionLimit:r,isAtLimit:n,onContentSelect:s,selectedContent:i,setExpandedTexts:l,setSelectedContent:c})=>{const d=w.useMemo(()=>e.filter(o=>o.type==="text"),[e]),u=o=>{if(!o&&i){const v=[...i];i.forEach((b,C)=>{b.type==="text"&&(v[C]={...b,selected:!1})}),c(v);return}const m=i.filter(v=>v.selected&&v.type!=="text").length,p=r()-m;if(p<=0)return;const g=[...i];let y=0;i.forEach((v,b)=>{v.type==="text"&&y<p&&(g[b]={...v,selected:!0},y++)}),c(g)},f=w.useMemo(()=>d.every(o=>{var m;return(m=i[i.findIndex(p=>p===o)])==null?void 0:m.selected}),[d,i]);return d.length?a.jsxs(Ae,{value:"text",className:"mb-2 last:mb-0",children:[a.jsx(De,{className:G("bg-card px-3 py-2 shadow-sm hover:bg-muted/50 hover:no-underline","data-[state=closed]:rounded-lg data-[state=open]:rounded-t-lg"),children:a.jsxs("div",{className:"flex w-full items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(ue,{checked:f,onCheckedChange:u,disabled:n&&!f,onClick:o=>o.stopPropagation(),className:"data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground"}),a.jsx("span",{className:"font-medium",children:"Selected text"})]}),a.jsxs("span",{className:"text-sm text-muted-foreground",children:[d.map(o=>o.content.split(" ").length).reduce((o,m)=>o+m,0)??0," ","Words"," "]})]})}),a.jsx(Me,{children:a.jsx("div",{className:"mt-0 w-full overflow-hidden rounded-b-lg bg-muted/5 p-4 shadow-sm",children:a.jsx("div",{className:"space-y-3",children:d.map((o,m)=>{const p=i.findIndex(y=>y===o)??-1;if(p===-1)return null;const g=t[p]??!1;return a.jsx("div",{className:"rounded-lg border bg-card p-3 transition-colors hover:bg-muted/50",onClick:()=>s==null?void 0:s(o,p),children:a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("div",{className:G("text-muted-foreground",!g&&"line-clamp-3"),children:o.content}),o.content.length>200&&a.jsx(oe,{variant:"ghost",size:"sm",className:"w-fit px-0 text-xs hover:bg-transparent",onClick:y=>{y.stopPropagation(),l(v=>({...v,[p]:!g}))},children:g?"Show Less":"Show More"})]})},m)})})})})]}):null};function ss({content:e,onClose:t}){var ft,mt;const r=w.useMemo(()=>{const h=[{...e[0],name:Pe(e[0].content,e[0].type),selected:e[0].type==="text"||e[0].type==="markdown"}],j=yn();j.length>0&&j.forEach(_=>{h.push({content:_,selected:!1,type:"link"})});const I=vn();return I.length>0&&I.forEach(_=>{h.push({content:_.src,name:_.alt||"image",selected:!1,type:"image"})}),h},[e]),[n,s]=w.useState(r),[i,l]=w.useState([]),[c,d]=w.useState(null),[u,f]=w.useState(!0),[o,m]=w.useState(()=>wn(r)),[p,g]=w.useState({}),[y,v]=w.useState(!1),[b,C]=w.useState(!1),[N,k]=w.useState(null),[ee,te]=w.useState(!1),[F,T]=w.useState(!1),[P,H]=w.useState(!1),[A,B]=w.useState(!1),S=cn(),[M,K]=w.useState({}),{data:X,isPending:ne}=bn();async function ye(h,j){if(!h||!h.length){k({message:"No content selected to upload",type:"error"});return}const I=j?Jt:Kr,se=(await Promise.all(h.map(async x=>{const z=crypto.randomUUID();if(K(Y=>({...Y,[z]:{fileName:x.name||Pe(x.content,x.type,{alt:x.name,src:x.type==="image"?x.content:void 0}),progress:0,status:"pending"}})),x.type==="link")return{attachmentType:"GLOBAL_LINK",id:z,source:j?"PROJECT":"VAULT",title:x.content,type:"GLOBAL_LINK",url:x.content};if(x.type==="text"||x.type==="markdown"){const Y=x.name||Pe(x.content,x.type),L=new File([x.content],Y,{type:"text/plain"});return{attachmentType:"GLOBAL_FILE",file:L,id:z,name:Y,source:j?"PROJECT":"VAULT",type:L.type.trim()!==""?L.type:"text/x-code"}}else if(x.type==="image"){const L=await(await fetch(x.content)).blob(),D=x.name?`${x.name}.${L.type.split("/")[1]}`:"image.jpg",W=new File([L],D,{type:L.type});return{attachmentType:"GLOBAL_IMAGE",file:W,id:z,name:D,source:j?"PROJECT":"VAULT",type:W.type}}}))).filter(x=>x!==void 0);I.getState().start(se,j&&{projectId:j}),await Promise.all(se.map(x=>new Promise((z,Y)=>{const L=setInterval(()=>{var pt,ht;const D=I.getState().currentFiles,W=(x==null?void 0:x.attachmentType)==="GLOBAL_LINK"?`${x==null?void 0:x.url}-${x==null?void 0:x.id}`:`${x==null?void 0:x.name}-${x==null?void 0:x.id}`;if(D[W]){let $=0;const Q=D[W].status;if((x==null?void 0:x.attachmentType)==="GLOBAL_LINK"){switch(Q){case"analysing":$=75;break;case"completed":$=100;break;case"failed":$=0;break;case"uploading":$=50;break;default:$=0}K(ae=>({...ae,[x.id]:{error:D[W].error,fileName:Ke(x.url||""),progress:$,status:Q}})),Q==="completed"?(clearInterval(L),z(!0)):Q==="failed"&&(clearInterval(L),Y(((pt=D[W])==null?void 0:pt.error)||"Upload failed"))}else{if(Q==="completed")$=100;else if(Q==="failed")$=0;else{const ae=typeof D[W].analysingProgress=="number"?D[W].analysingProgress:0;Q==="analysing"?$=50+ae/2:ae===100?$=75:$=ae/2}K(ae=>({...ae,[x.id]:{error:D[W].error,fileName:x.name||"File",progress:Math.round($),status:Q}})),Q==="completed"?(clearInterval(L),z(!0)):Q==="failed"&&(clearInterval(L),Y(((ht=D[W])==null?void 0:ht.error)||"Upload failed"))}}},500);setTimeout(()=>{clearInterval(L),K(D=>({...D,[x.id]:{...D[x.id],error:"Upload timed out",progress:0,status:"failed"}})),Y("Upload timed out")},5*60*1e3)})))}w.useEffect(()=>{X&&l(X)},[X]);const re=h=>{m(h)};async function dt(){if(n){te(!0);try{const h=Z(S.isFree),j=n.map((I,_)=>({...I,selected:_<h}));s(j),fe({eventData:{action:Ne?"deselect-all":"select-all",itemCount:n.length,source:window.location.href},eventName:"vault-select-all-button-selection",eventType:"Button",feature:"MerlinVault",firedFromFile:"features/vault/components/vaultPopup.tsx"}),n.length>h&&(k({message:`${S.isFree?"Free":"Pro"} users can only select up to ${h} files at once.${S.isFree?" Upgrade to select more.":""}`,type:"error"}),setTimeout(()=>{k(null)},3e3))}finally{te(!1)}}}async function V(h,j){var x;if(!n)return;const I=n.filter(z=>z.selected).length,_=(x=n==null?void 0:n[j])==null?void 0:x.selected;if(!_&&I>=Z(S.isFree)){k({message:`${S.isFree?"Free":"Pro"} users can only select up to ${Z(S.isFree)} files at once.${S.isFree?" Upgrade to select more.":""}`,type:"error"}),setTimeout(()=>{k(null)},3e3);return}const se=[...n];se[j]={...h,selected:!_},s(se),_&&k(null)}async function Zt(){if(n){te(!0);try{const h=n.map(j=>({...j,selected:!1}));s(h)}finally{te(!1)}}}async function qt(h){T(!0);try{await ye(h);const j=h.reduce((I,_)=>(I[_.type]=(I[_.type]||0)+1,I),{});fe({eventData:{contentTypes:j,itemCount:h.length,source:window.location.href},eventName:"vault-save-to-vault-button",eventType:"Button",feature:"MerlinVault",firedFromFile:"features/vault/components/vaultPopup.tsx"}),k({message:"Saved to Merlin Vault",type:"success"}),setTimeout(()=>{t()},3e3)}catch(j){console.error("Error saving to vault:",j),k({message:"Failed to save to vault",type:"error"})}finally{T(!1)}}async function en(h,j){var I;H(!0);try{await ye(h,j);const _=(I=i==null?void 0:i.find(x=>x.id===j))==null?void 0:I.name,se=h.reduce((x,z)=>(x[z.type]=(x[z.type]||0)+1,x),{});fe({eventData:{contentTypes:se,itemCount:h.length,projectId:j,projectName:_,source:window.location.href},eventName:"vault-save-to-project-button",eventType:"Button",feature:"MerlinVault",firedFromFile:"features/vault/components/vaultPopup.tsx"}),k({message:`Saved to project: ${_}`,type:"success"}),setTimeout(()=>{t()},5e3)}catch(_){console.error("Error saving to project:",_),k({message:"Failed to save to project",type:"error"})}finally{H(!1)}}async function ut(){const h=n==null?void 0:n.filter(I=>I.selected);if(!h||h.length===0){k({message:"Please select content to save",type:"error"}),setTimeout(()=>{k(null)},3e3);return}const j=Z(S.isFree);if(h.length>j){k({message:`${S.isFree?"Free":"Pro"} users can only save up to ${j} files at once.${S.isFree?" Upgrade to save more.":""}`,type:"error"}),setTimeout(()=>{k(null)},3e3);return}try{k(null),c?await en(h,c.id):await qt(h)}catch(I){console.error("Error saving content:",I),k({message:"Failed to save content",type:"error"}),setTimeout(()=>{k(null)},3e3)}}async function tn(){B(!0);try{C(!1),d(null)}finally{B(!1)}}const Ne=w.useMemo(()=>(n==null?void 0:n.every(h=>h.selected))??!1,[n]),R=w.useMemo(()=>Sn(n??[]),[n]);function nn(h){fe({eventData:{projectId:h.id,projectName:h.name,source:window.location.href},eventName:"vault-project-select-button",eventType:"Button",feature:"MerlinVault",firedFromFile:"features/vault/components/vaultPopup.tsx"}),d(h),v(!1)}return a.jsx(Mn,{onOpenChange:h=>{!h&&Object.keys(M).length>0&&!window.confirm("Closing this window might affect your upload. Are you sure you want to close?")||(f(h),h||t())},open:u,children:a.jsxs(Rn,{className:"z-[93847348238749] flex flex-col text-primary",children:[a.jsxs(Ln,{children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(On,{className:"font-serif text-xl text-primary",children:"Save to Merlin Vault"}),a.jsx("a",{className:"inline-flex items-center text-muted-foreground transition-colors hover:text-primary",href:"https://www.getmerlin.in/vault",onClick:h=>{h.stopPropagation(),fe({eventName:"vaultInfoClicked",eventType:"Link",feature:"Vault",firedFromFile:"features/vault/components/vaultPopup"})},rel:"noopener noreferrer",target:"_blank",children:a.jsx(Pn,{className:"h-4 w-4"})})]}),a.jsx("div",{className:"text-sm text-muted-foreground",children:"Bookmark everything in one place, and use them in Merlin chats and projects."}),S.isFree&&a.jsxs("div",{className:"text-sm text-muted-foreground",children:["$",S.isFree?"Free":"Pro"," users can select up to"," ",Z(S.isFree)," files at once. Upgrade for more."]})]}),a.jsxs("div",{className:"flex flex-col gap-2",children:[Object.keys(M).length>0&&a.jsxs("div",{className:"space-y-2 rounded-lg bg-neutral-50 p-3 dark:bg-neutral-900",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-sm font-medium",children:"Upload Progress"}),a.jsx("span",{className:"text-sm text-muted-foreground",children:jn(M)})]}),a.jsx("div",{className:"h-2 w-full overflow-hidden rounded-full bg-neutral-100 dark:bg-neutral-800",children:a.jsx("div",{className:"h-full bg-indigo-600 transition-all duration-300 ease-in-out dark:bg-indigo-400",style:{width:`${Nn(M)}%`}})}),a.jsx("div",{className:"space-y-1",children:Object.entries(M).map(([h,j])=>a.jsxs("div",{className:"flex items-center justify-between text-xs",children:[a.jsxs("span",{className:"truncate",children:[j.status==="completed"&&" ",j.status==="failed"&&" ",j.fileName||"File"]}),a.jsx("span",{className:G("text-muted-foreground",j.status==="completed"&&"text-green-600 dark:text-green-400",j.status==="failed"&&"text-red-600 dark:text-red-400"),children:j.status==="failed"?"Failed":j.status==="completed"?"100%":`${j.progress}%`})]},h))})]}),b?a.jsxs("div",{className:"mt-4 flex flex-col",children:[Object.keys(M).length===0&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"mb-2 text-sm font-medium text-primary",children:"Select a project to add your selected files"}),a.jsx("div",{className:"flex-1 rounded-lg",children:ne?a.jsx("div",{className:"flex items-center justify-center p-4",children:a.jsx(me,{className:"h-5 w-5 animate-spin"})}):i!=null&&i.length?a.jsxs("div",{className:"flex flex-col gap-4",children:[c&&a.jsx("div",{className:"flex cursor-pointer items-center justify-between rounded-xl border border-indigo-200 bg-gradient-to-r from-indigo-50 to-indigo-100 p-4 hover:bg-indigo-100/50 dark:border-indigo-800 dark:from-indigo-900/20 dark:to-indigo-800/20 dark:hover:bg-indigo-800/30",onClick:()=>{v(!0)},children:a.jsxs("div",{className:"flex items-center gap-3 truncate",children:[a.jsx("div",{className:"rounded-xl bg-gradient-to-br from-indigo-50 to-indigo-100/50 p-2 dark:from-indigo-950/50 dark:to-indigo-900/30",children:a.jsx(vt,{className:"h-4 w-4 text-indigo-600 dark:text-indigo-400"})}),a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("span",{className:"text-sm font-medium",children:(ft=i.find(h=>h.id===c.id))==null?void 0:ft.name}),a.jsx("span",{className:"truncate text-xs text-muted-foreground",children:(mt=i.find(h=>h.id===c.id))==null?void 0:mt.description})]})]})}),y?a.jsxs(Un,{className:"rounded-lg border-0",children:[a.jsx(Bn,{placeholder:"Search projects..."}),a.jsx(Vn,{children:"No projects found."}),a.jsx("div",{className:"h-[240px] overflow-y-auto",children:a.jsx(zn,{children:i.map(h=>a.jsx($n,{className:"group flex cursor-pointer items-center justify-between rounded-lg p-2 hover:bg-neutral-100 dark:hover:bg-neutral-800",onSelect:()=>{nn(h)},value:h.id,children:a.jsxs("div",{className:"flex items-center gap-3 truncate",children:[a.jsx("div",{className:"rounded-xl bg-gradient-to-br from-indigo-50 to-indigo-100/50 p-2 dark:from-indigo-950/50 dark:to-indigo-900/30",children:a.jsx(vt,{className:"h-4 w-4 text-indigo-600 dark:text-indigo-400"})}),a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("span",{className:"text-sm",children:h.name}),a.jsx("span",{className:"truncate text-xs text-muted-foreground",children:h.description})]})]})},h.id))})})]}):n&&n.length>0&&a.jsxs("div",{className:"mb-4 space-y-2",children:[a.jsx("p",{className:"text-sm font-medium",children:"Selected Files:"}),a.jsx("div",{className:"h-[240px] overflow-y-auto rounded-xl border",children:a.jsx("div",{className:"space-y-1 p-2",children:n.filter(h=>h.selected).map((h,j)=>a.jsx("div",{className:"group flex items-center justify-between rounded-lg p-2",children:a.jsxs("div",{className:"flex items-center gap-3 truncate",children:[a.jsxs("div",{className:"rounded-xl bg-gradient-to-br from-indigo-50 to-indigo-100/50 p-2 dark:from-indigo-950/50 dark:to-indigo-900/30",children:[h.type==="text"&&a.jsx(En,{className:"h-4 w-4 text-indigo-600 dark:text-indigo-400"}),h.type==="image"&&a.jsx(Fn,{className:"h-4 w-4 text-indigo-600 dark:text-indigo-400"}),h.type==="link"&&a.jsx(Tn,{className:"h-4 w-4 text-indigo-600 dark:text-indigo-400"}),h.type==="markdown"&&a.jsx(ar,{className:"h-4 w-4 text-indigo-600 dark:text-indigo-400"})]}),a.jsx("span",{className:"truncate text-sm",children:h.type==="link"?Ke(h.content):h.type==="markdown"?h.name:h.content})]})},j))})})]})]}):a.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"No projects found. Create one to save content."})})]}),N&&a.jsx("div",{className:G("mt-4 rounded px-3 py-1.5 text-center text-sm",N.type==="error"?"bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400":"bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400"),children:N.message}),a.jsxs(Gn,{className:"flex justify-between gap-2 border-t pt-4",children:[a.jsx(oe,{className:"flex items-center gap-2",disabled:A||P||(n==null?void 0:n.length)===0,onClick:tn,size:"sm",variant:"ghost",children:A?a.jsxs(a.Fragment,{children:[a.jsx(me,{className:"mr-2 h-4 w-4 animate-spin"}),"Going back..."]}):a.jsxs(a.Fragment,{children:[a.jsx(Zn,{className:"h-4 w-4"}),"Back"]})}),a.jsx(oe,{className:"flex items-center gap-2",disabled:!c||P||A||(n==null?void 0:n.length)===0,onClick:ut,size:"sm",variant:"default",children:P?a.jsxs(a.Fragment,{children:[a.jsx(me,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving to Project..."]}):a.jsxs(a.Fragment,{children:[a.jsx(qn,{className:"h-4 w-4"}),"Save Files"]})})]})]}):a.jsxs(a.Fragment,{children:[Object.keys(M).length===0&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"max-h-[50vh] overflow-y-auto",children:a.jsxs(_n,{className:"flex w-full flex-col rounded-md border",onValueChange:re,type:"multiple",value:o,children:[a.jsx(rs,{content:n??[],expandedTexts:p??{},getFileSelectionLimit:()=>Z(S.isFree),isAtLimit:Ce(n??[],S.isFree),onContentSelect:V,selectedContent:n??[],setExpandedTexts:g??{},setSelectedContent:s}),a.jsx(ns,{content:n??[],expandedTexts:p??{},getFileSelectionLimit:()=>Z(S.isFree),isAtLimit:Ce(n??[],S.isFree),onContentSelect:V,selectedContent:n??[],setExpandedTexts:g??{},setSelectedContent:s}),a.jsx(es,{content:n??[],getFileSelectionLimit:()=>Z(S.isFree),isAtLimit:Ce(n??[],S.isFree),onContentSelect:V,selectedContent:n??[],setSelectedContent:s??[]}),a.jsx(ts,{content:n??[],getFileSelectionLimit:()=>Z(S.isFree),isAtLimit:Ce(n??[],S.isFree),onContentSelect:V,selectedContent:n??[],setSelectedContent:s??[]})]})}),a.jsx(oe,{className:"w-full",disabled:ee||F||P,onClick:Ne?Zt:dt,size:"sm",variant:"outline",children:ee?a.jsxs(a.Fragment,{children:[a.jsx(me,{className:"mr-2 h-4 w-4 animate-spin"}),Ne?"Deselecting...":"Selecting..."]}):Ne?"Deselect All":"Select All"})]}),a.jsxs("div",{className:"text-sm text-muted-foreground",children:["Selected:"," ",R.text>0?`${R.text} text file, `:"",R.markdown>0?`${R.markdown} markdown file, `:"",R.images>0?`${R.images} images, `:"",R.links>0?`${R.links} links `:"","(approx. ",R.approxSize,")"]}),N&&a.jsx("div",{className:G("rounded px-3 py-1.5 text-center text-sm",N.type==="error"?"bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400":"bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400"),children:N.message}),a.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[a.jsx(oe,{className:"w-full",disabled:F||P||ee||parseInt(R.approxSize)===0,onClick:ut,variant:"secondary",children:F?a.jsxs(a.Fragment,{children:[a.jsx(me,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving to Vault..."]}):"Save to Vault"}),a.jsx(oe,{className:"w-full",disabled:F||P||ee||parseInt(R.approxSize)===0||R.images>0,onClick:()=>{fe({eventData:{source:window.location.href},eventName:"vault-navigate-to-projects-button",eventType:"Button",feature:"MerlinVault",firedFromFile:"features/vault/components/vaultPopup.tsx"}),C(!0),v(!0)},variant:"secondary",children:P?a.jsxs(a.Fragment,{children:[a.jsx(me,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving to Projects..."]}):"Save to Projects"})]}),R.images>0&&a.jsx("p",{className:"mt-1 text-center text-xs text-muted-foreground",children:" Images cannot be saved to projects."})]})]})]})})}function as(){const[e,t]=w.useState(null),[r,n]=w.useState(!1),[s,i]=w.useState({x:0,y:0}),[l,c]=w.useState(""),[d,u]=w.useState(!1),[f,o]=w.useState(!1),[m,p]=w.useState(!1),[g,y]=w.useState(!1),[v,b]=w.useState(!1),C=Ft();function N(){const F=window.getSelection();if(!F||F.rangeCount===0)return;const T=F.getRangeAt(0);if(!T)return;const P=T.getBoundingClientRect();P&&i({x:P.left,y:P.bottom+8})}w.useEffect(()=>{if(r)return;async function F(H){const A=window.getSelection(),B=(A==null?void 0:A.toString().trim())||"";if(!B){t(null),n(!1),c("");return}if(await new Promise(S=>setTimeout(S,10)),A&&A.rangeCount>0){const S=A.getRangeAt(0),M=S.getBoundingClientRect(),K=S.cloneContents(),X=document.createElement("div");X.appendChild(K.cloneNode(!0));const ne=Array.from(K.querySelectorAll("a")).map(V=>V.href),ye=Cn(X),re=[];ne.length>0?re.push({content:ye,type:"markdown"}):re.push({content:B,selected:!0,type:"text"}),ne.forEach(V=>{re.push({content:V,selected:!1,type:"link"})}),Array.from(K.querySelectorAll("img")).map(V=>V.src).forEach(V=>{re.push({content:V,selected:!1,type:"image"})}),M&&i({x:M.left,y:M.bottom+8}),t(re)}else t(null),n(!1),c("")}function T(H){const{action:A,from:B,payload:S}=H;A===dn.OPEN_MERLIN_VAULT&&B===un.BACKGROUND_SCRIPT&&(S!=null&&S.content&&(S!=null&&S.type)?(t([{content:S.content,type:S.type}]),n(!0)):S!=null&&S.selectionText&&(t([{content:S.selectionText,type:"text"}]),n(!0)))}function P(H){var A,B;if(((A=H.data)==null?void 0:A.from)==="saveButton"&&((B=H.data)!=null&&B.data)){const{content:S,showPopup:M,type:K,x:X,y:ne}=H.data.data;S&&(t([{content:S,selected:!0,type:K||"text"}]),i(X!==void 0&&ne!==void 0?{x:X,y:ne}:{x:window.innerWidth/2-200,y:window.scrollY+100}),M&&n(!0))}}return document.addEventListener("mouseup",F),window.addEventListener("message",P),window.addEventListener("scroll",N),window.addEventListener("wheel",N),gt.runtime.onMessage.addListener(T),window.addEventListener("message",T),()=>{document.removeEventListener("mouseup",F),window.removeEventListener("message",P),window.removeEventListener("scroll",N),window.removeEventListener("wheel",N),gt.runtime.onMessage.removeListener(T),window.removeEventListener("message",T)}},[r]),w.useEffect(()=>{e||u(!1)},[e]);function k(){e&&e[0]&&(navigator.clipboard.writeText(e[0].content),o(!0),setTimeout(()=>o(!1),2e3))}async function ee(){var F,T;try{p(!0),await C.update({vault:{blacklistedDomains:[...(T=(F=C.details)==null?void 0:F.vault)==null?void 0:T.blacklistedDomains,window.location.hostname],isEnabled:!0}}),b(!0)}catch(P){console.error("Error disabling on site:",P)}finally{p(!1)}}async function te(){var F,T;try{y(!0),await C.update({vault:{blacklistedDomains:[...(T=(F=C.details)==null?void 0:F.vault)==null?void 0:T.blacklistedDomains],isEnabled:!1}}),b(!0)}catch(P){console.error("Error disabling on all sites:",P)}finally{y(!1)}}return v?null:a.jsxs(a.Fragment,{children:[a.jsx(ir,{}),e&&!r&&!((s==null?void 0:s.x)===0||(s==null?void 0:s.y)===0)&&a.jsxs("div",{className:"fixed",style:{left:`${s.x}px`,top:`${s.y}px`,zIndex:999999},children:[a.jsxs("div",{className:"flex items-center gap-3 rounded-full bg-black px-3 py-2 text-white shadow-[0_0_0_1px_rgba(255,255,255,0.1),0_2px_8px_rgba(0,0,0,0.3)] ring-1 ring-white/10",children:[a.jsx(hn,{className:"h-5 w-5"}),a.jsxs("button",{className:"flex items-center gap-1 text-sm text-white hover:opacity-70",onClick:k,children:[f?a.jsx("svg",{className:"h-4 w-4 text-green-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{d:"M5 13l4 4L19 7",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2})}):a.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5})}),"Copy"]}),a.jsxs("button",{className:"flex items-center gap-1 text-sm text-white hover:opacity-70",onClick:()=>n(!0),children:[a.jsx(An,{className:"h-4 w-4"}),"Save to Vault"]}),a.jsx("button",{className:"flex h-5 w-5 items-center justify-center hover:opacity-70",onClick:()=>{u(!d)},children:a.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{d:"M6 18L18 6M6 6l12 12",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2})})})]}),d&&a.jsxs("div",{className:"absolute right-0 top-[calc(100%+1px)] max-w-48 rounded-lg bg-black py-1 shadow-lg ring-1 ring-white/10",children:[a.jsxs("button",{className:"flex w-full items-center justify-between px-4 py-2 text-left text-sm text-white hover:bg-white/10 disabled:cursor-not-allowed disabled:opacity-50",disabled:m||g,onClick:ee,children:[a.jsx("span",{children:"Disable on this site"}),m&&a.jsx(yt,{className:"ml-2 h-4 w-4 animate-spin"})]}),a.jsxs("button",{className:"flex w-full items-center justify-between px-4 py-2 text-left text-sm text-white hover:bg-white/10 disabled:cursor-not-allowed disabled:opacity-50",disabled:m||g,onClick:te,children:[a.jsx("span",{children:"Disable on all sites"}),g&&a.jsx(yt,{className:"ml-2 h-4 w-4 animate-spin"})]})]})]}),r&&e&&a.jsx(ss,{content:e,onClose:()=>{n(!1),t(null)}})]})}function is(){var n,s,i,l;const e=Ft(),t=(s=(n=e.details)==null?void 0:n.vault)==null?void 0:s.isEnabled,r=w.useMemo(()=>{var c,d;return(d=(c=e.details)==null?void 0:c.vault)==null?void 0:d.blacklistedDomains.includes(window.location.hostname)},[(l=(i=e.details)==null?void 0:i.vault)==null?void 0:l.blacklistedDomains]);return!t||r?null:a.jsx(fn,{children:a.jsx(mn,{children:a.jsx(pn,{children:a.jsx(as,{})})})})}async function os(){if(!(await rt.fetchQuery(It.MerlinConfig)).saveToMerlin.visible||document.getElementById("merlin-vault"))return;const t=document.createElement("merlin-component");t.id="merlin-vault",t.className="merlin vault";const r=t.attachShadow({mode:"open"}),n=document.createElement("style");n.textContent=`${er}
        :host(#merlin-vault) {
        }
        .reactAppRoot {
            all: initial;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2147483647;
        }
    `;const s=document.createElement("div");s.id="reactAppRoot",s.className="reactAppRoot",rn.forEach(l=>{s.addEventListener(l,c=>{c.stopPropagation()})}),r.appendChild(n),r.appendChild(s),tr(t),sn(s).render(a.jsx(is,{}))}os();
